<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corvallis ç¾é£Ÿåœ°åœ– - å’–å•¡åº—èˆ‡é¤å»³ ğŸ—ºï¸</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        * { box-sizing: border-box; }
        
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif; 
            overflow: hidden; 
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
        }
        
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* --- å·¦ä¸Šè§’æ¨™é¡Œé¢æ¿å„ªåŒ– --- */
        .title-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f9f9f9 100%);
            padding: 20px 24px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.05);
            z-index: 1000;
            border-left: 5px solid #6f4e37;
            max-width: 300px;
            animation: slideInLeft 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            backdrop-filter: blur(10px);
        }

        .title-panel h1 { 
            margin: 0; 
            color: #6f4e37; 
            font-size: 1.5rem; 
            font-weight: 700;
            display: flex; 
            align-items: center; 
            gap: 10px;
            letter-spacing: -0.5px;
        }
        
        .title-panel p { 
            margin: 10px 0 0; 
            color: #666; 
            font-size: 0.9rem; 
            line-height: 1.5;
        }

        .subtitle {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.85rem;
            color: #888;
        }

        /* --- å³ä¸Šè§’ç¯©é¸æ§åˆ¶å™¨å„ªåŒ– --- */
        .filter-control {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.97);
            padding: 12px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.05);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 6px;
            animation: slideInRight 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .filter-control h3 {
            margin: 0 0 8px 0;
            padding: 0 8px;
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .filter-btn {
            border: none;
            background: transparent;
            padding: 10px 16px;
            text-align: left;
            cursor: pointer;
            border-radius: 10px;
            font-size: 0.95rem;
            color: #555;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .filter-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: currentColor;
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .filter-btn:hover { 
            background: #f5f5f5; 
            transform: translateX(3px);
        }
        
        /* æ¿€æ´»ç‹€æ…‹å„ªåŒ– */
        .filter-btn.active { 
            background: linear-gradient(135deg, #6f4e37 0%, #5a3d2d 100%);
            color: white; 
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(111, 78, 55, 0.3);
        }
        
        .filter-btn.active::before {
            transform: scaleY(1);
        }
        
        .filter-btn.active i { color: #fff; }

        .filter-btn i {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .filter-btn:hover i {
            transform: scale(1.2);
        }

        /* ä¸åŒåˆ†é¡çš„ icon é¡è‰² */
        .icon-aesthetic { color: #2c8e3c; }
        .icon-study { color: #e67e22; }
        .icon-nerd { color: #9b59b6; }
        .icon-community { color: #e74c3c; }

        /* è¨ˆæ•¸å™¨å¾½ç«  */
        .count-badge {
            margin-left: auto;
            background: rgba(111, 78, 55, 0.1);
            color: #6f4e37;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 700;
            min-width: 24px;
            text-align: center;
        }

        .filter-btn.active .count-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* --- Popup æ¨£å¼å¤§å¹…å„ªåŒ– --- */
        .leaflet-popup-content-wrapper {
            border-radius: 16px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-content {
            margin: 0;
            width: 300px !important;
        }

        .popup-header {
            background: linear-gradient(135deg, #6f4e37 0%, #5a3d2d 100%);
            color: white;
            padding: 16px 18px;
            font-size: 1.15rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.3px;
        }

        .popup-header i {
            font-size: 1.3rem;
            opacity: 0.9;
        }

        .popup-body { 
            padding: 18px; 
            background: white;
        }
        
        .popup-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 14px;
        }
        
        .feature-tag {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%);
            color: #4a5568;
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 16px;
            border: 1px solid #dae4f7;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: transform 0.2s ease;
        }

        .feature-tag:hover {
            transform: translateY(-2px);
        }

        .popup-desc { 
            font-size: 0.95rem; 
            color: #555; 
            line-height: 1.6; 
            margin-bottom: 16px;
        }
        
        .popup-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: linear-gradient(135deg, #2c8e3c 0%, #27753a 100%);
            color: white;
            text-align: center;
            text-decoration: none;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(44, 142, 60, 0.2);
        }
        
        .popup-btn:hover { 
            background: linear-gradient(135deg, #27753a 0%, #1e5a2d 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(44, 142, 60, 0.3);
        }

        .popup-btn i {
            font-size: 1rem;
        }

        /* Leaflet popup æ¨£å¼èª¿æ•´ */
        .leaflet-popup-tip {
            background: white;
        }

        /* --- è‡ªè¨‚ Marker åœ–æ¨™ --- */
        .custom-marker {
            background: white;
            border: 3px solid #6f4e37;
            border-radius: 50% 50% 50% 0;
            width: 40px;
            height: 40px;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .custom-marker i {
            transform: rotate(45deg);
            color: #6f4e37;
            font-size: 1.2rem;
        }

        .custom-marker:hover {
            transform: rotate(-45deg) scale(1.15);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        /* ä¸åŒé¡åˆ¥çš„ marker é¡è‰² */
        /* å’–å•¡åº—é¡åˆ¥ */
        .marker-aesthetic { border-color: #2c8e3c; }
        .marker-aesthetic i { color: #2c8e3c; }

        .marker-study { border-color: #e67e22; }
        .marker-study i { color: #e67e22; }

        .marker-nerd { border-color: #9b59b6; }
        .marker-nerd i { color: #9b59b6; }

        .marker-community { border-color: #e74c3c; }
        .marker-community i { color: #e74c3c; }

        /* é¤å»³é¡åˆ¥ - ä½¿ç”¨ä¸åŒçš„é¡è‰² */
        .marker-restaurant { border-color: #dc2626; }
        .marker-restaurant i { color: #dc2626; }

        /* å‹•ç•«å„ªåŒ– */
        @keyframes slideInLeft { 
            from { transform: translateX(-100px); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }
        
        @keyframes slideInRight { 
            from { transform: translateX(100px); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }

        @keyframes markerDrop {
            0% { transform: translateY(-200px) scale(0.5); opacity: 0; }
            60% { transform: translateY(10px) scale(1.1); opacity: 1; }
            80% { transform: translateY(-5px) scale(0.95); }
            100% { transform: translateY(0) scale(1); }
        }

        .marker-animate {
            animation: markerDrop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* Loading å‹•ç•« */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            animation: fadeOut 0.5s ease 2s forwards;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6f4e37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeOut {
            to { opacity: 0; pointer-events: none; }
        }

        .loading-text {
            color: #6f4e37;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* RWD æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media (max-width: 768px) {
            .title-panel { 
                top: 10px; 
                left: 10px; 
                right: 10px; 
                max-width: none; 
                padding: 16px;
            }
            
            .title-panel h1 {
                font-size: 1.3rem;
            }

            .subtitle {
                display: none;
            }
            
            .filter-control { 
                top: auto; 
                bottom: 15px; 
                right: 10px; 
                left: 10px; 
                flex-direction: row; 
                overflow-x: auto; 
                padding: 10px;
                gap: 8px;
                scrollbar-width: none;
            }

            .filter-control::-webkit-scrollbar {
                display: none;
            }

            .filter-control h3 {
                display: none;
            }
            
            .filter-btn { 
                flex: 0 0 auto; 
                padding: 8px 14px; 
                font-size: 0.85rem;
                white-space: nowrap;
            }
            
            .filter-btn.active { 
                transform: translateY(-3px);
            }

            .count-badge {
                font-size: 0.7rem;
                padding: 2px 6px;
            }

            .leaflet-popup-content {
                width: 260px !important;
            }
        }

        /* æš—è‰²æ¨¡å¼æ”¯æ´ (å¯é¸) */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
            }

            .title-panel {
                background: linear-gradient(135deg, #2c2c2c 0%, #252525 100%);
                color: #e0e0e0;
            }

            .title-panel h1 {
                color: #d4a574;
            }

            .title-panel p {
                color: #b0b0b0;
            }

            .filter-control {
                background: rgba(44, 44, 44, 0.97);
            }

            .filter-btn {
                color: #e0e0e0;
            }

            .filter-btn:hover {
                background: #3a3a3a;
            }
        }

        /* --- æ–°å¢å’–å•¡åº—æŒ‰éˆ• --- */
        .add-shop-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6f4e37 0%, #5a3d2d 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(111, 78, 55, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-shop-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 24px rgba(111, 78, 55, 0.6);
        }

        /* --- è¡¨å–®æ¨¡æ…‹è¦–çª— --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #6f4e37 0%, #5a3d2d 100%);
            color: white;
            padding: 24px 28px;
            border-radius: 20px 20px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #6f4e37;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-help {
            font-size: 0.85rem;
            color: #888;
            margin-top: 6px;
        }

        .features-input-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .feature-input-row {
            display: flex;
            gap: 8px;
        }

        .feature-input-row input {
            flex: 1;
        }

        .feature-input-row button {
            padding: 8px 12px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .feature-input-row button:hover {
            background: #e0e0e0;
        }

        .add-feature-btn {
            padding: 10px 16px;
            background: #6f4e37;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s ease;
        }

        .add-feature-btn:hover {
            background: #5a3d2d;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }

        .btn-primary,
        .btn-secondary {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2c8e3c 0%, #27753a 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #27753a 0%, #1e5a2d 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 142, 60, 0.3);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #555;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* æ‰‹æ©Ÿç‰ˆè¡¨å–®å„ªåŒ– */
        @media (max-width: 768px) {
            .add-shop-btn {
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
            }

            .add-shop-btn:hover {
                transform: translateX(-50%) scale(1.1) rotate(90deg);
            }

            .modal-content {
                width: 95%;
                max-height: 85vh;
            }

            .modal-body {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <!-- Loading å‹•ç•« -->
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ğŸ—ºï¸ æ­£åœ¨æº–å‚™ç¾é£Ÿåœ°åœ–...</div>
    </div>

    <div class="title-panel">
        <h1><i class="fas fa-map-marked-alt"></i> Corvallis ç¾é£Ÿåœ°åœ–</h1>
        <p>æ¢ç´¢ Corvallis æœ€æ£’çš„å’–å•¡åº—èˆ‡é¤å»³ï¼é¸æ“‡å³å´é¸å–®ç¯©é¸ä½ æƒ³è¦çš„é¡åˆ¥ã€‚</p>
        <div class="subtitle">ğŸ¯ é»æ“Šåœ°åœ–æ¨™è¨˜æŸ¥çœ‹è©³ç´°è³‡è¨Š</div>
    </div>

    <div class="filter-control">
        <h3>ä¸»é¡åˆ¥</h3>
        <button class="filter-btn active" data-category="all" data-type="main" onclick="filterMarkers('all')">
            <i class="fas fa-layer-group"></i>
            <span>å…¨éƒ¨é¡¯ç¤º</span>
            <span class="count-badge" id="count-all">0</span>
        </button>
        <button class="filter-btn" data-category="coffee" data-type="main" onclick="filterMarkers('coffee')">
            <i class="fas fa-mug-hot"></i>
            <span>å’–å•¡åº—</span>
            <span class="count-badge" id="count-coffee">0</span>
        </button>
        <button class="filter-btn" data-category="restaurant" data-type="main" onclick="filterMarkers('restaurant')">
            <i class="fas fa-utensils"></i>
            <span>é¤å»³</span>
            <span class="count-badge" id="count-restaurant">0</span>
        </button>

        <div id="coffeeSubcategories" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0;">
            <h3>å’–å•¡åº—é¡å‹</h3>
            <button class="filter-btn" data-category="aesthetic" data-type="coffee" onclick="filterMarkers('aesthetic')">
                <i class="fas fa-leaf icon-aesthetic"></i>
                <span>æ°£æ°›ç¾æ„Ÿ</span>
                <span class="count-badge" id="count-aesthetic">0</span>
            </button>
            <button class="filter-btn" data-category="study" data-type="coffee" onclick="filterMarkers('study')">
                <i class="fas fa-laptop icon-study"></i>
                <span>è®€æ›¸å·¥ä½œ</span>
                <span class="count-badge" id="count-study">0</span>
            </button>
            <button class="filter-btn" data-category="nerd" data-type="coffee" onclick="filterMarkers('nerd')">
                <i class="fas fa-glasses icon-nerd"></i>
                <span>å’–å•¡è¡Œå®¶</span>
                <span class="count-badge" id="count-nerd">0</span>
            </button>
            <button class="filter-btn" data-category="community" data-type="coffee" onclick="filterMarkers('community')">
                <i class="fas fa-users icon-community"></i>
                <span>æº«é¦¨èšæœƒ</span>
                <span class="count-badge" id="count-community">0</span>
            </button>
        </div>

        <div id="restaurantSubcategories" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0;">
            <h3>é¤å»³é¡å‹</h3>
            <button class="filter-btn" data-category="mexican" data-type="restaurant" onclick="filterMarkers('mexican')">
                <i class="fas fa-pepper-hot" style="color: #dc2626;"></i>
                <span>å¢¨è¥¿å“¥</span>
                <span class="count-badge" id="count-mexican">0</span>
            </button>
            <button class="filter-btn" data-category="chinese" data-type="restaurant" onclick="filterMarkers('chinese')">
                <i class="fas fa-dragon" style="color: #dc2626;"></i>
                <span>ä¸­å¼</span>
                <span class="count-badge" id="count-chinese">0</span>
            </button>
            <button class="filter-btn" data-category="middle-eastern" data-type="restaurant" onclick="filterMarkers('middle-eastern')">
                <i class="fas fa-mosque" style="color: #059669;"></i>
                <span>ä¸­æ±</span>
                <span class="count-badge" id="count-middle-eastern">0</span>
            </button>
            <button class="filter-btn" data-category="korean" data-type="restaurant" onclick="filterMarkers('korean')">
                <i class="fas fa-fire" style="color: #dc2626;"></i>
                <span>éŸ“å¼</span>
                <span class="count-badge" id="count-korean">0</span>
            </button>
            <button class="filter-btn" data-category="european" data-type="restaurant" onclick="filterMarkers('european')">
                <i class="fas fa-wine-glass" style="color: #7c3aed;"></i>
                <span>æ­ç¾</span>
                <span class="count-badge" id="count-european">0</span>
            </button>
            <button class="filter-btn" data-category="pizza" data-type="restaurant" onclick="filterMarkers('pizza')">
                <i class="fas fa-pizza-slice" style="color: #ea580c;"></i>
                <span>æŠ«è–©</span>
                <span class="count-badge" id="count-pizza">0</span>
            </button>
            <button class="filter-btn" data-category="sandwich" data-type="restaurant" onclick="filterMarkers('sandwich')">
                <i class="fas fa-hamburger" style="color: #c2410c;"></i>
                <span>ä¸‰æ˜æ²»/æ¼¢å ¡</span>
                <span class="count-badge" id="count-sandwich">0</span>
            </button>
            <button class="filter-btn" data-category="bar" data-type="restaurant" onclick="filterMarkers('bar')">
                <i class="fas fa-beer" style="color: #d97706;"></i>
                <span>é…’å§</span>
                <span class="count-badge" id="count-bar">0</span>
            </button>
            <button class="filter-btn" data-category="indian" data-type="restaurant" onclick="filterMarkers('indian')">
                <i class="fas fa-om" style="color: #ea580c;"></i>
                <span>å°åº¦</span>
                <span class="count-badge" id="count-indian">0</span>
            </button>
            <button class="filter-btn" data-category="thai" data-type="restaurant" onclick="filterMarkers('thai')">
                <i class="fas fa-leaf" style="color: #16a34a;"></i>
                <span>æ³°å¼</span>
                <span class="count-badge" id="count-thai">0</span>
            </button>
        </div>
    </div>

    <div id="map"></div>

    <!-- æ–°å¢å’–å•¡åº—/é¤å»³æŒ‰éˆ• -->
    <button class="add-shop-btn" onclick="openModal()">
        <i class="fas fa-plus"></i>
    </button>

    <!-- è¡¨å–®æ¨¡æ…‹è¦–çª— -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-map-marker-alt"></i> æ–°å¢åœ°é»</h2>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="coffeeShopForm" onsubmit="submitForm(event)">
                    <div class="form-group">
                        <label for="placeType">é¡å‹ *</label>
                        <select id="placeType" name="placeType" required onchange="updateCategoryOptions()">
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="coffee">å’–å•¡åº—</option>
                            <option value="restaurant">é¤å»³</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="shopName">åç¨± *</label>
                        <input type="text" id="shopName" name="shopName" required placeholder="ä¾‹å¦‚ï¼šGreenhouse Coffee + Plants">
                    </div>

                    <div class="form-group">
                        <label for="category">é¡åˆ¥ *</label>
                        <select id="category" name="category" required onchange="updateIconByCategory()">
                            <option value="">è«‹å…ˆé¸æ“‡é¡å‹...</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="latitude">ç·¯åº¦ (Latitude) *</label>
                            <input type="number" id="latitude" name="latitude" step="any" required placeholder="44.5643">
                            <div class="form-help">å¯å¾ Google Maps å–å¾—</div>
                        </div>
                        <div class="form-group">
                            <label for="longitude">ç¶“åº¦ (Longitude) *</label>
                            <input type="number" id="longitude" name="longitude" step="any" required placeholder="-123.2614">
                            <div class="form-help">å¯å¾ Google Maps å–å¾—</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="icon">åœ–ç¤ºåç¨± *</label>
                        <input type="text" id="icon" name="icon" required placeholder="ä¾‹å¦‚ï¼šleaf, coffee, book">
                        <div class="form-help">ä½¿ç”¨ Font Awesome åœ–ç¤ºåç¨±ï¼ˆä¸å« fa-ï¼‰</div>
                    </div>

                    <div class="form-group">
                        <label for="description">è©³ç´°æè¿° *</label>
                        <textarea id="description" name="description" required placeholder="æè¿°å’–å•¡åº—çš„ç‰¹è‰²ã€æ°›åœã€æ¨è–¦é£²å“ç­‰..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>ç‰¹è‰²æ¨™ç±¤</label>
                        <div class="features-input-container" id="featuresContainer">
                            <div class="feature-input-row">
                                <input type="text" placeholder="ä¾‹å¦‚ï¼šğŸ“¸ é©åˆæ‹ç…§" class="feature-input">
                                <button type="button" onclick="removeFeature(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="add-feature-btn" onclick="addFeatureInput()">
                            <i class="fas fa-plus"></i> æ–°å¢æ¨™ç±¤
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="googleMapsLink">Google Maps é€£çµ</label>
                        <input type="url" id="googleMapsLink" name="googleMapsLink" placeholder="https://www.google.com/maps/place/...">
                        <div class="form-help">é¸å¡«ï¼šå¾ Google Maps è¤‡è£½åˆ†äº«é€£çµ</div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-check"></i> æäº¤
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- 1. è©³ç´°åº—å®¶è³‡æ–™åº« ---
        const defaultPlaces = [
            // å’–å•¡åº—
            {
                id: 1,
                name: "Greenhouse Coffee + Plants",
                type: "coffee",
                category: "aesthetic",
                lat: 44.5643,
                lng: -123.2614,
                icon: "leaf",
                desc: "è¢«æ¤ç‰©åŒ…åœçš„æº«å®¤å’–å•¡å»³,å…‰ç·šéå¸¸å……è¶³,å¿ƒæƒ…æœƒè®Šå¾ˆå¥½ã€‚åº—å…§åŒæ™‚è²©å”®ç²¾é¸æ¤æ ½,è®“ä½ å¯ä»¥æŠŠç¶ æ„å¸¶å›å®¶ã€‚",
                features: ["ğŸ“¸ é©åˆæ‹ç…§", "ğŸŒ± æœ‰è³£æ¤ç‰©", "â˜€ï¸ æ¡å…‰ä½³"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJi3lah6xBwFQRnmEChZrqk1g"
            },
            {
                id: 2,
                name: "Futura Coffee Roasters",
                type: "coffee",
                category: "aesthetic",
                lat: 44.5629,
                lng: -123.2601,
                icon: "seedling",
                desc: "å‰èº«ç‚º Tried & Trueã€‚ç¾ä»£å·¥æ¥­é¢¨è¨­è¨ˆ,å°ˆæ³¨æ–¼æ°¸çºŒè¾²æ¥­èˆ‡é«˜å“è³ªæ‰‹æ²–ã€‚æ¯ä¸€æ¯å’–å•¡éƒ½æ˜¯è—è¡“å“ã€‚",
                features: ["â˜• æ‰‹æ²–å’–å•¡", "ğŸ§± å·¥æ¥­é¢¨", "ğŸŒ æ°¸çºŒç’°ä¿"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJgwQZuutAwFQR_hYeRaEI8Tk"
            },
            {
                id: 3,
                name: "Interzone",
                type: "coffee",
                category: "study",
                lat: 44.5677,
                lng: -123.2738,
                icon: "guitar",
                desc: "æ ¡å€æ—çš„é¾å…‹æ–æ»¾é¢¨æ ¼åº—ã€‚é–‹å¾—æ¯”è¼ƒæ™š,é©åˆéœ€è¦ç‰¹æ®Šéˆæ„Ÿçš„æ™‚å€™ã€‚æœ‰æ©Ÿç‡•éº¥ç²¥å’Œè²æœä¹Ÿå€¼å¾—ä¸€è©¦ã€‚",
                features: ["ğŸ¸ æ–æ»¾Vibe", "ğŸ¦‰ é–‹åˆ°è¼ƒæ™š", "ğŸ¥£ æœ‰æ©Ÿç‡•éº¥ç²¥"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJZ0Gk571AwFQR3i_43l-BJkI"
            },
            {
                id: 4,
                name: "Coffee Culture (Kings)",
                type: "coffee",
                category: "study",
                lat: 44.5778,
                lng: -123.2748,
                icon: "book",
                desc: "ç©ºé–“å¯¬æ•ã€æ’åº§å¤š,æ˜¯è¨±å¤š OSU å­¸ç”Ÿè¶•è«–æ–‡çš„ç§˜å¯†åŸºåœ°ã€‚è‡ªå®¶çƒ˜ç„™çš„é»å¿ƒä¹Ÿå¾ˆå—æ­¡è¿ã€‚",
                features: ["ğŸ’» æ’åº§å¤š", "ğŸ“š é©åˆè®€æ›¸", "ğŸ¥¯ è‡ªå®¶çƒ˜ç„™é»å¿ƒ"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJK8GsEZxAwFQRwjxaGThm9lU"
            },
            {
                id: 5,
                name: "Oregon Coffee & Tea",
                type: "coffee",
                category: "nerd",
                lat: 44.5650,
                lng: -123.2595,
                icon: "coffee",
                desc: "æ•¸åå¹´è€åº—,å°ˆæ³¨æ–¼è²©å”®æ–°é®®çƒ˜ç„™è±†èˆ‡èŒ¶è‘‰,è¡Œå®¶å¿…å»ã€‚ä¸€èµ°é€²å»å°±æœƒè¢«è±†å­çš„é¦™æ°£åŒ…åœã€‚",
                features: ["ğŸ›ï¸ è²·è±†é¦–é¸", "ğŸ‘ƒ é¦™æ°£å››æº¢", "ğŸµ èŒ¶è‘‰é¸æ“‡å¤š"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJu3p_dutAwFQRnqeobhWXnuU"
            },
            {
                id: 6,
                name: "Imagine Coffee Co.",
                type: "coffee",
                category: "community",
                lat: 44.5501,
                lng: -123.3130,
                icon: "music",
                desc: "åƒæ˜¯ç¤¾å€å®¢å»³ä¸€æ¨£æº«æš–,å¸¸æœ‰ç¾å ´éŸ³æ¨‚æ¼”å¥èˆ‡è—è¡“å±•è¦½ã€‚åœ¨é€™è£¡ä½ æœƒé‡åˆ°å¾ˆå¤šæœ‰è¶£çš„æœ¬åœ°äººã€‚",
                features: ["ğŸ¨ è—è¡“å±•è¦½", "ğŸµ ç¾å ´éŸ³æ¨‚", "ğŸ›‹ï¸ æ²™ç™¼å€"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJhffwvEBHwFQRLy-xUiAV0GY"
            },
            {
                id: 7,
                name: "Bodhi Cafe & Bakery",
                type: "coffee",
                category: "community",
                lat: 44.5600,
                lng: -123.2622,
                icon: "bread-slice",
                desc: "éºµåŒ…æ˜¯æœ¬é«”!ä½¿ç”¨åœ¨åœ°é£Ÿæè£½ä½œçš„æ—©åˆé¤éå¸¸å—æ­¡è¿ã€‚è±†è”»æ‹¿éµæ­é…å‰›å‡ºçˆçš„éºµåŒ…æ˜¯çµ•é…ã€‚",
                features: ["ğŸ¥ è¶…å¼·éºµåŒ…", "ğŸ¥ª æ—©åˆé¤", "ğŸ˜ï¸ æˆ¶å¤–åº§ä½"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJww_2m3VBwFQRfyir2HHDTsE"
            },

            // é¤å»³ - å¢¨è¥¿å“¥æ–™ç†
            {
                id: 101,
                name: "Oscar's Tacos and Cantina",
                type: "restaurant",
                category: "mexican",
                lat: 44.5640,
                lng: -123.2625,
                icon: "pepper-hot",
                desc: "é«˜å“è³ªã€ç¾å‘³ä¸”ä»½é‡å……è¶³çš„å¢¨è¥¿å“¥æ–™ç†ã€‚æ‹›ç‰Œæ¨è–¦ï¼šGobernador å¢¨è¥¿å“¥æ²é¤…ã€Carnitas å¢¨è¥¿å“¥æ²é¤…ã€ç‰ç±³ç‰‡ (Nachos)ã€‚ç”œé»æœ‰çµ•å°ç¾å‘³çš„æ³•è˜­ (Flan)ã€‚è¼•é¬†ä¼‘é–’ï¼Œå“¡å·¥å‹å–„ï¼Œæœå‹™å‡ºè‰²ã€‚",
                features: ["â­ 4.9 æ˜Ÿ", "ğŸŒ® å¢¨è¥¿å“¥æ²é¤…", "ğŸ® æ³•è˜­ç”œé»", "ä»½é‡å……è¶³"],
                link: "#"
            },
            {
                id: 102,
                name: "El charro negro",
                type: "restaurant",
                category: "mexican",
                lat: 44.5650,
                lng: -123.2640,
                icon: "pepper-hot",
                desc: "æ­£å®—çš„å¢¨è¥¿å“¥é¢¨å‘³ï¼Œä»½é‡æ¥µå¤§ (ä¸€ä»½è¶³å¤  1.5 åˆ° 2 é¤)ã€‚æ‹›ç‰Œæ¨è–¦ï¼šQuesabirria (æ­é…æ¹¯æ± ConsommÃ©)ã€Pollo Locoã€‚æä¾›ç¾å‘³çš„ç„¡é…’ç²¾è¦†ç›†å­ç‘ªæ ¼éº—ç‰¹ã€‚å¤§å­¸ç”Ÿå¯äº« 8 æŠ˜å„ªæƒ ï¼",
                features: ["â­ 4.7 æ˜Ÿ", "ğŸ“ å¤§å­¸ç”Ÿ 8 æŠ˜", "ğŸ¥˜ Quesabirria", "ä»½é‡è¶…å¤§"],
                link: "#"
            },

            // é¤å»³ - ä¸­å¼æ–™ç†
            {
                id: 103,
                name: "Tian Fu Noodle / DIY Hotpot (å¤©åºœéºµé£Ÿ)",
                type: "restaurant",
                category: "chinese",
                lat: 44.5670,
                lng: -123.2700,
                icon: "fire",
                desc: "æ°£æ°›æº«é¦¨çš„ä¸­å¼é¤å»³ï¼Œä¸»æ‰“éºµé£Ÿå’Œå‰µæ„çš„è‡ªåŠ©ç«é‹ã€‚æä¾›å®¢è£½åŒ–çš„ã€ŒDIY è‡ªåŠ©ç«é‹ã€ï¼Œéº»é†¬æ¹¯åº•è¢«é¡§å®¢è­½ç‚ºã€Œå…¨å ´ç„¦é»ã€ã€‚æ‰‹å·¥æ°´é¤ƒå’Œæ“”æ“”éºµä¹Ÿæ·±å—å–œæ„›ã€‚",
                features: ["â­ 4.8 æ˜Ÿ", "ğŸœ æ‰‹å·¥éºµé£Ÿ", "ğŸ² è‡ªåŠ©ç«é‹", "éº»é†¬æ¹¯åº•"],
                link: "https://www.google.com/maps/search/?api=1&query=Tian+Fu+Noodle+1425+NW+Monroe+Ave+Corvallis"
            },

            // é¤å»³ - ä¸­æ±æ–™ç†
            {
                id: 104,
                name: "Khalo Naser Syrian Cuisine & Lounge",
                type: "restaurant",
                category: "middle-eastern",
                lat: 44.5634,
                lng: -123.2618,
                icon: "mosque",
                desc: "å®¶åº­ç¶“ç‡Ÿçš„æ•˜åˆ©äº/ä¸­æ±é¤å»³ã€‚æ‹›ç‰Œèœï¼šå·´å·´åŠ åŠªä»€ã€ç¾Šè‚‰ä¸²æ²ã€é›è‚‰æ²™å¨ç‘ªæ‹¼ç›¤ã€é˜¿æ‹‰ä¼¯æ²™å¨ç‘ªå’Œç¾Šè†ã€‚æ°›åœè¼•é¬†èˆ’é©æ™‚å°šï¼Œå“¡å·¥éå¸¸å‹å¥½ï¼Œè®“äººæ„Ÿè¦ºåƒè¢«é‚€è«‹åˆ°æº«æš–çš„å®¶åº­ä½œå®¢ã€‚",
                features: ["â­ 4.8 æ˜Ÿ", "ğŸ¥™ æ²™å¨ç‘ª", "ğŸ– ç¾Šè‚‰ä¸²", "å®¶åº­ç¶“ç‡Ÿ"],
                link: "https://www.google.com/maps/search/?api=1&query=Khalo+Naser+115+NW+Jackson+Ave+Corvallis"
            },

            // é¤å»³ - éŸ“å¼æ–™ç†
            {
                id: 105,
                name: "K-BBQ EXPRESS",
                type: "restaurant",
                category: "korean",
                lat: 44.5710,
                lng: -123.2730,
                icon: "fire",
                desc: "æä¾›é«˜å“è³ªã€å¿«é€Ÿæœå‹™çš„éŸ“å¼ç‡’çƒ¤å¿«é¤åº—ã€‚é¡§å®¢ç‰¹åˆ¥æ¨è–¦çƒ¤è‚‰æ‹Œé£¯ (Bulgogi Bibimbap) å’ŒéŸ“å¼é£¯æ² (Kimbap)ã€‚å°æ–¼è¶•æ™‚é–“çš„å­¸ç”Ÿå’Œä¸Šç­æ—ä¾†èªªï¼Œåˆé¤ç‰¹é¤éå¸¸ç†æƒ³ã€‚è€é—†éå¸¸è¦ªåˆ‡ã€‚",
                features: ["â­ 4.6 æ˜Ÿ", "ğŸ± çƒ¤è‚‰æ‹Œé£¯", "ğŸ™ éŸ“å¼é£¯æ²", "å¿«é€Ÿæœå‹™"],
                link: "https://www.google.com/maps/search/?api=1&query=K-BBQ+EXPRESS+2461+NW+Monroe+Ave+Corvallis"
            },

            // é¤å»³ - æ­ç¾æ–™ç†
            {
                id: 106,
                name: "Caves Corvallis",
                type: "restaurant",
                category: "european",
                lat: 44.5621,
                lng: -123.2582,
                icon: "wine-glass",
                desc: "èˆ’é©çš„å°é…’é¤¨ï¼Œæä¾›çµåˆæ­æ´²å’Œç¾å¼é¢¨å‘³çš„æ™‚ä»¤èœå–®ï¼ŒåŒæ™‚æä¾›å…¨çƒç²¾é‡€å•¤é…’ã€‚èœé¤šç¶“éç²¾å¿ƒçƒ¹èª¿ï¼Œé¢¨å‘³ç¨ç‰¹ä¸”å¹³è¡¡ã€‚èˆ’é©æ™‚å°šï¼Œæä¾›æ—©åˆé¤ã€åˆé¤å’Œæ™šé¤ï¼Œå¯ä»¥é è¨‚ã€‚",
                features: ["â­ 4.6 æ˜Ÿ", "ğŸ· ç²¾é‡€å•¤é…’", "ğŸ½ï¸ æ™‚ä»¤èœå–®", "æˆ¶å¤–åº§ä½"],
                link: "https://www.google.com/maps/search/?api=1&query=Caves+Corvallis+308+SW+3rd+St+Corvallis"
            },

            // é¤å»³ - æŠ«è–©
            {
                id: 107,
                name: "Cirello's Pizza",
                type: "restaurant",
                category: "pizza",
                lat: 44.5655,
                lng: -123.2615,
                icon: "pizza-slice",
                desc: "ç´ç´„å¼æŠ«è–©ã€‚ä»½é‡æ…·æ…¨ï¼Œé¤¡æ–™è±å¯Œï¼Œé¤…çš®å’Œé…æ–™è³ªé‡é«˜ã€‚æ‹›ç‰Œæ¨è–¦ï¼šè¥¿è¥¿é‡ŒæŠ«è–© (Sicilian)ï¼Œå–œæ­¡å¤§è’œçš„è©±å¯ä»¥é¸æ“‡çƒ¤å¤§è’œå£å‘³ã€‚ç¶“å…¸çš„ 1980 å¹´ä»£æŠ«è–©åº—é«”é©—ï¼Œèˆ’é©ä¼‘é–’ã€‚",
                features: ["â­ 4.4 æ˜Ÿ", "ğŸ• ç´ç´„å¼", "ğŸ§„ çƒ¤å¤§è’œ", "ä»½é‡æ…·æ…¨"],
                link: "#"
            },
            {
                id: 108,
                name: "American Dream Pizza Downtown",
                type: "restaurant",
                category: "pizza",
                lat: 44.5630,
                lng: -123.2590,
                icon: "pizza-slice",
                desc: "ä»¥æ•´ä»½æˆ–å–®ç‰‡è²©å”®çš„åšç‰‡æŠ«è–©èåï¼Œæä¾›å¤šç¨®ç´ é£Ÿé¸é …å’Œç„¡éº©è³ªé¤…çš®ã€‚æ™‚é«¦ã€ä¼‘é–’ä¸”å……æ»¿æ´»åŠ›ï¼Œè¨­æœ‰ç¨ç«‹é…’å§å€ï¼Œå¤å­£é‚„æœ‰å±‹é ‚åº§ä½ã€‚è¨±å¤šäººç¨±è®šå®ƒæ˜¯ã€ŒWillamette Valley æœ€æ£’çš„æŠ«è–©ã€ã€‚",
                features: ["â­ 4.3 æ˜Ÿ", "ğŸ• åšç‰‡æŠ«è–©", "ğŸŒ± ç´ é£Ÿé¸é …", "ğŸ™ï¸ å±‹é ‚åº§ä½"],
                link: "#"
            },

            // é¤å»³ - ä¸‰æ˜æ²»/æ¼¢å ¡
            {
                id: 109,
                name: "Swan Dive Sandwiches + Bar",
                type: "restaurant",
                category: "sandwich",
                lat: 44.5625,
                lng: -123.2605,
                icon: "bread-slice",
                desc: "ä»¥é«˜å“è³ªçš„ä¸‰æ˜æ²»èåï¼Œæ‰€æœ‰é£Ÿæè¶…ç´šæ–°é®®ã€åœ¨åœ°æ¡è³¼ï¼ŒéºµåŒ…æ›´æ˜¯è‡ªå®¶è£½ä½œï¼Œå£å‘³çµ„åˆå¯Œæœ‰å‰µæ„ã€‚æ°›åœæ¥µä½³ï¼Œæœå‹™å‡ºè‰²ï¼Œå“¡å·¥ç†±æƒ…å¥½å®¢ã€‚é¡§å®¢è©•è«–ï¼šã€ŒéºµåŒ…æ˜¯ä¸»è§’ã€ã€ã€ŒCorvallis æœ€æ£’çš„ä¸‰æ˜æ²»ã€ã€‚",
                features: ["â­ 4.8 æ˜Ÿ", "ğŸ¥– è‡ªå®¶éºµåŒ…", "ğŸ¥— åœ¨åœ°é£Ÿæ", "å‰µæ„å£å‘³"],
                link: "#"
            },
            {
                id: 110,
                name: "Bo & Vine Burger Corvallis",
                type: "restaurant",
                category: "sandwich",
                lat: 44.5645,
                lng: -123.2610,
                icon: "hamburger",
                desc: "å°ˆé–€çš„ç¾é£Ÿæ‰‹å·¥æ¼¢å ¡åº—ã€‚ç‰¹è‰²æ˜¯ç¨å‰µçš„é…æ–™ï¼Œå¦‚åŸ¹æ ¹æœé†¬å’Œæ«»æ¡ƒå“ˆç“¦é‚£è¾£æ¤’é†¬ã€‚æä¾›å®¢è£½åŒ–é†¬æ–™å§å’Œç´ é£Ÿé¸é … (å¦‚è±†é¡æ¼¢å ¡)ã€‚æ°›åœéš¨æ€§æ™‚é«¦ï¼Œç¸½æ˜¯äººæ°£å¾ˆæ—ºã€‚",
                features: ["â­ 4.4 æ˜Ÿ", "ğŸ” æ‰‹å·¥æ¼¢å ¡", "ğŸ¥“ åŸ¹æ ¹æœé†¬", "å®¢è£½é†¬æ–™"],
                link: "#"
            },

            // é¤å»³ - é…’å§
            {
                id: 111,
                name: "Beer:30",
                type: "restaurant",
                category: "bar",
                lat: 44.5540,
                lng: -123.2550,
                icon: "beer",
                desc: "é©åˆæ”¾é¬†ä¼‘é–’çš„ç¤¾å€é…’å§ï¼Œå°ˆé–€æä¾›ç²¾é‡€å•¤é…’ã€‚æ°£æ°›è¼•é¬†æ‚ é–’ï¼Œæœ‰è¶…é 30 ç¨®ç”Ÿå•¤é…’å’Œè˜‹æœé…’è¼ªæµä¾›æ‡‰ï¼Œç²¾é¸äº†è¨±å¤šåœ°å€æ€§çš„å„ªè³ªå•¤é…’ã€‚åƒ¹æ ¼éå¸¸åˆç†ã€‚",
                features: ["â­ 4.8 æ˜Ÿ", "ğŸº 30+ ç”Ÿå•¤", "ğŸ è˜‹æœé…’", "åƒ¹æ ¼åˆç†"],
                link: "https://www.google.com/maps/search/?api=1&query=Beer:30+1835+SE+3rd+St+Corvallis"
            },
            {
                id: 112,
                name: "Squirrels Tavern",
                type: "restaurant",
                category: "bar",
                lat: 44.5618,
                lng: -123.2580,
                icon: "beer",
                desc: "æ­·å²æ‚ ä¹…ã€åœ¨ç§‘ç“¦åˆ©æ–¯éå¸¸è‘—åçš„é…’é¤¨ã€‚è¼•é¬†çš„é…’å§æ°›åœã€å¤æ€ªçš„è£é£¾ã€æ’çƒæ¡Œå’Œå½ˆç æ©Ÿã€‚ç¾å‘³çš„é…’å§é£Ÿç‰©ï¼Œä¾‹å¦‚åŸ¹æ ¹èµ·å¸æ¼¢å ¡å’Œç‚¸è–¯æ¢ã€‚æœå‹™å‹å–„ï¼Œç•¶åœ°è€å­—è™Ÿã€‚",
                features: ["â­ 4.6 æ˜Ÿ", "ğŸ± æ’çƒæ¡Œ", "ğŸ” é…’å§é£Ÿç‰©", "ç•¶åœ°è€åº—"],
                link: "https://www.google.com/maps/search/?api=1&query=Squirrels+Tavern+100+SW+2nd+St+Corvallis"
            },

            // é¤å»³ - å°åº¦æ–™ç†
            {
                id: 113,
                name: "Royal India Cuisine - Corvallis",
                type: "restaurant",
                category: "indian",
                lat: 44.5740,
                lng: -123.2690,
                icon: "om",
                desc: "æä¾›é“åœ°å°åº¦é¢¨å‘³çš„é¤å»³ï¼Œä»¥é¢¨å‘³æ¿ƒéƒçš„èœé¤šã€ç„¡å¯æŒ‘å‰”çš„æœå‹™å’Œèˆ’é©ä¼‘é–’çš„æ°›åœèåã€‚æ‹›ç‰Œèœï¼šç¾Šè‚‰å’–å“©ã€é·¹å˜´è±†å’–å“© (Chana Masala)ã€çƒ¤é¤… (Naan)ã€è”¬èœåº«çˆ¾ç‘ªã€‚æä¾›ç´ é£Ÿå’Œç´”ç´ é£Ÿé¸é …ã€‚",
                features: ["â­ 4.6 æ˜Ÿ", "ğŸ› å’–å“©", "ğŸ«“ çƒ¤é¤… Naan", "ç´ é£Ÿé¸é …"],
                link: "https://www.google.com/maps/search/?api=1&query=Royal+India+Cuisine+1857+NW+9th+St+Corvallis"
            },

            // é¤å»³ - æ³°å¼æ–™ç†
            {
                id: 114,
                name: "Tarn Tip Thai Cuisine",
                type: "restaurant",
                category: "thai",
                lat: 44.5720,
                lng: -123.2740,
                icon: "leaf",
                desc: "ä¼‘é–’èˆ’é©çš„å°é¤é¤¨ï¼Œæä¾›æ³°å¼å®¶å¸¸èœï¼ŒåŒ…æ‹¬ç´ é£Ÿé¸é …ã€‚æ‹›ç‰Œèœï¼šé¦™è„†ç¾…å‹’é´¨ã€é…ªæ¢¨å’–å“©ã€æ³°å¼çƒ¤é›ã€é³³æ¢¨ç‚’é£¯ã€é¦™è„†è±¬äº”èŠ±ã€‚å„ªè³ªå¿«é€Ÿçš„æœå‹™ï¼Œç¾å‘³çš„é¤é»è€Œå—åˆ°é«˜åº¦è®šæšã€‚",
                features: ["â­ 4.6 æ˜Ÿ", "ğŸ¦† ç¾…å‹’é´¨", "ğŸ¥‘ é…ªæ¢¨å’–å“©", "ç´ é£Ÿé¸é …"],
                link: "https://www.google.com/maps/search/?api=1&query=Tarn+Tip+Thai+2535+NW+Monroe+Ave+Corvallis"
            }
        ];

        // --- 1.5. localStorage æ•´åˆï¼šåˆä½µé è¨­è³‡æ–™å’Œä½¿ç”¨è€…è³‡æ–™ ---
        function loadPlacesFromStorage() {
            const userPlaces = localStorage.getItem('userCoffeeShops');
            if (userPlaces) {
                try {
                    return [...defaultPlaces, ...JSON.parse(userPlaces)];
                } catch (e) {
                    console.error('Error loading user data:', e);
                    return defaultPlaces;
                }
            }
            return defaultPlaces;
        }

        function savePlaceToStorage(newPlace) {
            const userPlaces = localStorage.getItem('userCoffeeShops');
            let placesArray = [];

            if (userPlaces) {
                try {
                    placesArray = JSON.parse(userPlaces);
                } catch (e) {
                    placesArray = [];
                }
            }

            placesArray.push(newPlace);
            localStorage.setItem('userCoffeeShops', JSON.stringify(placesArray));
        }

        // åˆå§‹åŒ– places é™£åˆ—ï¼ˆåˆä½µé è¨­è³‡æ–™å’Œä½¿ç”¨è€…è³‡æ–™ï¼‰
        let places = loadPlacesFromStorage();

        // --- 2. åˆå§‹åŒ–åœ°åœ– ---
        const map = L.map('map', { 
            zoomControl: false,
            minZoom: 11,
            maxZoom: 18
        }).setView([44.6000, -123.2600], 12);
        
        // åŠ å…¥ç¸®æ”¾æ§åˆ¶å™¨åˆ°å³ä¸‹è§’
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // ä½¿ç”¨æ›´ç¾è§€çš„åœ°åœ–ç“¦ç‰‡
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 20
        }).addTo(map);

        // é£›å…¥å‹•ç•«
        setTimeout(() => {
            map.flyTo([44.5646, -123.2620], 14, { 
                duration: 2,
                easeLinearity: 0.5
            });
        }, 500);

        // --- 3. è‡ªè¨‚ Marker Icon ---
        function createCustomIcon(category, iconName) {
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="custom-marker marker-${category} marker-animate"><i class="fas fa-${iconName}"></i></div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });
        }

        // --- 4. æ¨™è¨˜ç®¡ç†é‚è¼¯ ---
        let markersLayer = L.layerGroup().addTo(map);
        let currentMarkers = [];

        // Icon å°æ‡‰è¡¨
        const categoryIcons = {
            // å’–å•¡åº—
            'aesthetic': 'leaf',
            'study': 'laptop',
            'nerd': 'glasses',
            'community': 'users',
            // é¤å»³
            'mexican': 'pepper-hot',
            'chinese': 'dragon',
            'middle-eastern': 'mosque',
            'korean': 'fire',
            'european': 'wine-glass',
            'pizza': 'pizza-slice',
            'sandwich': 'hamburger',
            'bar': 'beer',
            'indian': 'om',
            'thai': 'leaf'
        };

        function createPopupContent(place) {
            const tagsHtml = place.features.map(f => `<span class="feature-tag">${f}</span>`).join('');
            
            return `
                <div class="popup-header">
                    <i class="fas fa-${place.icon}"></i>
                    <span>${place.name}</span>
                </div>
                <div class="popup-body">
                    <div class="popup-tag-container">${tagsHtml}</div>
                    <div class="popup-desc">${place.desc}</div>
                    <a href="${place.link}" target="_blank" class="popup-btn">
                        <i class="fas fa-location-arrow"></i>
                        <span>åœ¨ Google Maps ä¸­é–‹å•Ÿ</span>
                    </a>
                </div>
            `;
        }

        function filterMarkers(category) {
            // 1. æ›´æ–°æŒ‰éˆ•ç‹€æ…‹å’Œå­é¡åˆ¥é¡¯ç¤º
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // æ‰¾åˆ°å°æ‡‰æŒ‰éˆ•ä¸¦æ·»åŠ  active class
            const activeBtn = document.querySelector(`.filter-btn[data-category="${category}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            // æ§åˆ¶å­é¡åˆ¥é¡¯ç¤º/éš±è—
            const coffeeSubcategories = document.getElementById('coffeeSubcategories');
            const restaurantSubcategories = document.getElementById('restaurantSubcategories');

            if (category === 'coffee') {
                coffeeSubcategories.style.display = 'block';
                restaurantSubcategories.style.display = 'none';
            } else if (category === 'restaurant') {
                coffeeSubcategories.style.display = 'none';
                restaurantSubcategories.style.display = 'block';
            } else if (category === 'all') {
                coffeeSubcategories.style.display = 'none';
                restaurantSubcategories.style.display = 'none';
            }

            // 2. æ¸…é™¤åœ°åœ–ä¸Šçš„æ¨™è¨˜
            markersLayer.clearLayers();
            currentMarkers = [];

            // 3. ç¯©é¸è³‡æ–™
            let filteredPlaces;
            if (category === 'all') {
                filteredPlaces = places;
            } else if (category === 'coffee') {
                filteredPlaces = places.filter(p => p.type === 'coffee');
            } else if (category === 'restaurant') {
                filteredPlaces = places.filter(p => p.type === 'restaurant');
            } else {
                // å­é¡åˆ¥ç¯©é¸
                filteredPlaces = places.filter(p => p.category === category);
            }

            // 4. é‡æ–°åŠ ä¸Šæ¨™è¨˜ (å¸¶æœ‰è½ä¸‹å‹•ç•«æ•ˆæœ)
            filteredPlaces.forEach((place, index) => {
                setTimeout(() => {
                    const markerCategory = place.type === 'restaurant' ? 'restaurant' : place.category;
                    const icon = createCustomIcon(markerCategory, place.icon);
                    const marker = L.marker([place.lat, place.lng], { icon: icon });

                    marker.bindPopup(createPopupContent(place), {
                        maxWidth: 300,
                        className: 'custom-popup'
                    });

                    // æ·»åŠ é»æ“Šäº‹ä»¶
                    marker.on('click', function() {
                        map.setView([place.lat, place.lng], 15, {
                            animate: true,
                            duration: 0.5
                        });
                    });

                    // åŠ å…¥åœ–å±¤
                    marker.addTo(markersLayer);
                    currentMarkers.push(marker);

                    // å¦‚æœåªæœ‰ä¸€å€‹çµæœ,è‡ªå‹•èšç„¦
                    if (filteredPlaces.length === 1) {
                        map.setView([place.lat, place.lng], 16, {
                            animate: true,
                            duration: 1
                        });
                        setTimeout(() => marker.openPopup(), 800);
                    }
                }, index * 100);
            });

            // 5. å¦‚æœæœ‰å¤šå€‹çµæœ,èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
            if (filteredPlaces.length > 1) {
                setTimeout(() => {
                    const bounds = L.latLngBounds(filteredPlaces.map(p => [p.lat, p.lng]));
                    map.fitBounds(bounds, {
                        padding: [60, 60],
                        maxZoom: 14,
                        animate: true,
                        duration: 0.8
                    });
                }, filteredPlaces.length * 100 + 200);
            }
        }

        // åˆå§‹è¼‰å…¥å…¨éƒ¨
        setTimeout(() => {
            filterMarkers('all');
        }, 2500);

        // --- 5. æ›´æ–°è¨ˆæ•¸å™¨ ---
        function updateCounts() {
            const counts = {
                // ä¸»é¡åˆ¥
                all: places.length,
                coffee: places.filter(p => p.type === 'coffee').length,
                restaurant: places.filter(p => p.type === 'restaurant').length,

                // å’–å•¡åº—å­é¡åˆ¥
                aesthetic: places.filter(p => p.category === 'aesthetic').length,
                study: places.filter(p => p.category === 'study').length,
                nerd: places.filter(p => p.category === 'nerd').length,
                community: places.filter(p => p.category === 'community').length,

                // é¤å»³å­é¡åˆ¥
                mexican: places.filter(p => p.category === 'mexican').length,
                chinese: places.filter(p => p.category === 'chinese').length,
                'middle-eastern': places.filter(p => p.category === 'middle-eastern').length,
                korean: places.filter(p => p.category === 'korean').length,
                european: places.filter(p => p.category === 'european').length,
                pizza: places.filter(p => p.category === 'pizza').length,
                sandwich: places.filter(p => p.category === 'sandwich').length,
                bar: places.filter(p => p.category === 'bar').length,
                indian: places.filter(p => p.category === 'indian').length,
                thai: places.filter(p => p.category === 'thai').length
            };

            Object.keys(counts).forEach(category => {
                const badge = document.getElementById(`count-${category}`);
                if (badge) {
                    badge.textContent = counts[category];
                }
            });
        }

        // åˆå§‹åŒ–è¨ˆæ•¸å™¨
        updateCounts();

        // --- 6. è¡¨å–®ç®¡ç†å‡½æ•¸ ---
        function openModal() {
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
        }

        function updateCategoryOptions() {
            const placeTypeSelect = document.getElementById('placeType');
            const categorySelect = document.getElementById('category');
            const placeType = placeTypeSelect.value;

            // æ¸…ç©ºç¾æœ‰é¸é …
            categorySelect.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';

            if (placeType === 'coffee') {
                categorySelect.innerHTML += `
                    <option value="aesthetic">æ°£æ°›ç¾æ„Ÿ - é©åˆæ‹ç…§ã€ç’°å¢ƒå„ªç¾</option>
                    <option value="study">è®€æ›¸å·¥ä½œ - æ’åº§å¤šã€é©åˆå­¸ç¿’</option>
                    <option value="nerd">å’–å•¡è¡Œå®¶ - å°ˆæ³¨å’–å•¡å“è³ª</option>
                    <option value="community">æº«é¦¨èšæœƒ - ç¤¾å€å‹å–„ã€é©åˆèšæœƒ</option>
                `;
            } else if (placeType === 'restaurant') {
                categorySelect.innerHTML += `
                    <option value="mexican">å¢¨è¥¿å“¥æ–™ç†</option>
                    <option value="chinese">ä¸­å¼æ–™ç†</option>
                    <option value="middle-eastern">ä¸­æ±æ–™ç†</option>
                    <option value="korean">éŸ“å¼æ–™ç†</option>
                    <option value="european">æ­ç¾æ–™ç†</option>
                    <option value="pizza">æŠ«è–©</option>
                    <option value="sandwich">ä¸‰æ˜æ²»/æ¼¢å ¡</option>
                    <option value="bar">é…’å§</option>
                    <option value="indian">å°åº¦æ–™ç†</option>
                    <option value="thai">æ³°å¼æ–™ç†</option>
                `;
            }
        }

        function updateIconByCategory() {
            const categorySelect = document.getElementById('category');
            const iconInput = document.getElementById('icon');
            const category = categorySelect.value;

            // æ ¹æ“šé¡åˆ¥è‡ªå‹•å¡«å…¥å°æ‡‰çš„åœ–ç¤º
            if (category && categoryIcons[category]) {
                iconInput.value = categoryIcons[category];
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = ''; // æ¢å¾©æ»¾å‹•
            document.getElementById('coffeeShopForm').reset();

            // é‡ç½®ç‰¹è‰²æ¨™ç±¤ç‚ºä¸€å€‹è¼¸å…¥æ¡†
            const container = document.getElementById('featuresContainer');
            container.innerHTML = `
                <div class="feature-input-row">
                    <input type="text" placeholder="ä¾‹å¦‚ï¼šğŸ“¸ é©åˆæ‹ç…§" class="feature-input">
                    <button type="button" onclick="removeFeature(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        function closeModalOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeModal();
            }
        }

        function addFeatureInput() {
            const container = document.getElementById('featuresContainer');
            const newRow = document.createElement('div');
            newRow.className = 'feature-input-row';
            newRow.innerHTML = `
                <input type="text" placeholder="ä¾‹å¦‚ï¼šğŸ“¸ é©åˆæ‹ç…§" class="feature-input">
                <button type="button" onclick="removeFeature(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(newRow);
        }

        function removeFeature(button) {
            const container = document.getElementById('featuresContainer');
            const row = button.parentElement;

            // è‡³å°‘ä¿ç•™ä¸€å€‹è¼¸å…¥æ¡†
            if (container.children.length > 1) {
                row.remove();
            } else {
                // å¦‚æœåªå‰©ä¸€å€‹ï¼Œæ¸…ç©ºå®ƒ
                const input = row.querySelector('input');
                input.value = '';
            }
        }

        function submitForm(event) {
            event.preventDefault();

            // æ”¶é›†è¡¨å–®è³‡æ–™
            const form = event.target;
            const formData = new FormData(form);

            // æ”¶é›†æ‰€æœ‰ç‰¹è‰²æ¨™ç±¤
            const featureInputs = document.querySelectorAll('.feature-input');
            const features = Array.from(featureInputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');

            // ç”Ÿæˆæ–°çš„ IDï¼ˆä½¿ç”¨æ™‚é–“æˆ³ä¾†ç¢ºä¿å”¯ä¸€æ€§ï¼‰
            const newId = Date.now();

            // å»ºç«‹æ–°çš„åœ°é»ç‰©ä»¶
            const newPlace = {
                id: newId,
                name: formData.get('shopName'),
                type: formData.get('placeType'),
                category: formData.get('category'),
                lat: parseFloat(formData.get('latitude')),
                lng: parseFloat(formData.get('longitude')),
                icon: formData.get('icon'),
                desc: formData.get('description'),
                features: features,
                link: formData.get('googleMapsLink') || '#'
            };

            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!newPlace.name || !newPlace.type || !newPlace.category || !newPlace.lat || !newPlace.lng || !newPlace.icon || !newPlace.desc) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
                return;
            }

            // é©—è­‰åº§æ¨™ç¯„åœï¼ˆCorvallis å€åŸŸï¼‰
            if (newPlace.lat < 44.0 || newPlace.lat > 45.0 || newPlace.lng > -122.0 || newPlace.lng < -124.0) {
                if (!confirm('æ‚¨è¼¸å…¥çš„åº§æ¨™ä¼¼ä¹ä¸åœ¨ Corvallis å€åŸŸï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                    return;
                }
            }

            // ä¿å­˜åˆ° localStorage
            savePlaceToStorage(newPlace);

            // æ·»åŠ åˆ° places é™£åˆ—
            places.push(newPlace);

            // æ›´æ–°è¨ˆæ•¸å™¨
            updateCounts();

            // é‡æ–°è¼‰å…¥åœ°åœ–æ¨™è¨˜
            filterMarkers('all');

            // é—œé–‰è¡¨å–®ä¸¦é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            closeModal();
            const placeTypeName = newPlace.type === 'coffee' ? 'å’–å•¡åº—' : 'é¤å»³';
            alert('âœ… ' + placeTypeName + 'å·²æˆåŠŸæ–°å¢ï¼\n\n' + newPlace.name + ' å·²ç¶“åŠ å…¥åœ°åœ–äº†ã€‚');

            // è‡ªå‹•èšç„¦åˆ°æ–°å¢çš„åœ°é»
            setTimeout(() => {
                map.setView([newPlace.lat, newPlace.lng], 16, {
                    animate: true,
                    duration: 1
                });

                // æ‰¾åˆ°ä¸¦é–‹å•Ÿæ–°æ¨™è¨˜çš„ popup
                setTimeout(() => {
                    currentMarkers.forEach(marker => {
                        const markerLatLng = marker.getLatLng();
                        if (markerLatLng.lat === newPlace.lat && markerLatLng.lng === newPlace.lng) {
                            marker.openPopup();
                        }
                    });
                }, 500);
            }, 300);
        }

        // éµç›¤å¿«æ·éµï¼šæŒ‰ Esc é—œé–‰æ¨¡æ…‹è¦–çª—
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('modalOverlay');
                if (modal.classList.contains('active')) {
                    closeModal();
                }
            }
        });

    </script>
</body>
</html>
