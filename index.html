<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corvallis ç¾é£Ÿåœ°åœ– - å’–å•¡åº—èˆ‡é¤å»³ ğŸ—ºï¸</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        * { box-sizing: border-box; }
        
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif; 
            overflow: hidden; 
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
        }
        
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* --- å·¦ä¸Šè§’æ¨™é¡Œé¢æ¿å„ªåŒ– --- */
        .title-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f9f9f9 100%);
            padding: 20px 24px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.05);
            z-index: 1000;
            border-left: 5px solid #6f4e37;
            max-width: 300px;
            animation: slideInLeft 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            backdrop-filter: blur(10px);
        }

        .title-panel h1 { 
            margin: 0; 
            color: #6f4e37; 
            font-size: 1.5rem; 
            font-weight: 700;
            display: flex; 
            align-items: center; 
            gap: 10px;
            letter-spacing: -0.5px;
        }
        
        .title-panel p { 
            margin: 10px 0 0; 
            color: #666; 
            font-size: 0.9rem; 
            line-height: 1.5;
        }

        .subtitle {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.85rem;
            color: #888;
        }

        /* --- å³ä¸Šè§’ç¯©é¸æ§åˆ¶å™¨å„ªåŒ– --- */
        .filter-control {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.97);
            padding: 12px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.05);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 6px;
            animation: slideInRight 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .filter-control h3 {
            margin: 0 0 8px 0;
            padding: 0 8px;
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .filter-btn {
            border: none;
            background: transparent;
            padding: 10px 16px;
            text-align: left;
            cursor: pointer;
            border-radius: 10px;
            font-size: 0.95rem;
            color: #555;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .filter-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: currentColor;
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .filter-btn:hover { 
            background: #f5f5f5; 
            transform: translateX(3px);
        }
        
        /* æ¿€æ´»ç‹€æ…‹å„ªåŒ– */
        .filter-btn.active { 
            background: linear-gradient(135deg, #6f4e37 0%, #5a3d2d 100%);
            color: white; 
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(111, 78, 55, 0.3);
        }
        
        .filter-btn.active::before {
            transform: scaleY(1);
        }
        
        .filter-btn.active i { color: #fff; }

        .filter-btn i {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .filter-btn:hover i {
            transform: scale(1.2);
        }

        /* ä¸åŒåˆ†é¡çš„ icon é¡è‰² */
        .icon-aesthetic { color: #2c8e3c; }
        .icon-study { color: #e67e22; }
        .icon-nerd { color: #9b59b6; }
        .icon-community { color: #e74c3c; }

        /* è¨ˆæ•¸å™¨å¾½ç«  */
        .count-badge {
            margin-left: auto;
            background: rgba(111, 78, 55, 0.1);
            color: #6f4e37;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 700;
            min-width: 24px;
            text-align: center;
        }

        .filter-btn.active .count-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* --- Popup æ¨£å¼å¤§å¹…å„ªåŒ– --- */
        .leaflet-popup-content-wrapper {
            border-radius: 16px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-content {
            margin: 0;
            width: 300px !important;
        }

        .popup-header {
            background: linear-gradient(135deg, #6f4e37 0%, #5a3d2d 100%);
            color: white;
            padding: 16px 18px;
            font-size: 1.15rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.3px;
        }

        .popup-header i {
            font-size: 1.3rem;
            opacity: 0.9;
        }

        .popup-body { 
            padding: 18px; 
            background: white;
        }
        
        .popup-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 14px;
        }
        
        .feature-tag {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%);
            color: #4a5568;
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 16px;
            border: 1px solid #dae4f7;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: transform 0.2s ease;
        }

        .feature-tag:hover {
            transform: translateY(-2px);
        }

        .popup-desc { 
            font-size: 0.95rem; 
            color: #555; 
            line-height: 1.6; 
            margin-bottom: 16px;
        }
        
        .popup-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: linear-gradient(135deg, #2c8e3c 0%, #27753a 100%);
            color: white;
            text-align: center;
            text-decoration: none;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(44, 142, 60, 0.2);
        }
        
        .popup-btn:hover { 
            background: linear-gradient(135deg, #27753a 0%, #1e5a2d 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(44, 142, 60, 0.3);
        }

        .popup-btn i {
            font-size: 1rem;
        }

        /* Leaflet popup æ¨£å¼èª¿æ•´ */
        .leaflet-popup-tip {
            background: white;
        }

        /* --- è‡ªè¨‚ Marker åœ–æ¨™ --- */
        .custom-marker {
            background: white;
            border: 3px solid #6f4e37;
            border-radius: 50% 50% 50% 0;
            width: 40px;
            height: 40px;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .custom-marker i {
            transform: rotate(45deg);
            color: #6f4e37;
            font-size: 1.2rem;
        }

        .custom-marker:hover {
            transform: rotate(-45deg) scale(1.15);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        /* ä¸åŒé¡åˆ¥çš„ marker é¡è‰² */
        /* å’–å•¡åº—é¡åˆ¥ */
        .marker-aesthetic { border-color: #2c8e3c; }
        .marker-aesthetic i { color: #2c8e3c; }

        .marker-study { border-color: #e67e22; }
        .marker-study i { color: #e67e22; }

        .marker-nerd { border-color: #9b59b6; }
        .marker-nerd i { color: #9b59b6; }

        .marker-community { border-color: #e74c3c; }
        .marker-community i { color: #e74c3c; }

        /* é¤å»³é¡åˆ¥ - ä½¿ç”¨ä¸åŒçš„é¡è‰² */
        .marker-restaurant { border-color: #dc2626; }
        .marker-restaurant i { color: #dc2626; }

        /* å‹•ç•«å„ªåŒ– */
        @keyframes slideInLeft { 
            from { transform: translateX(-100px); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }
        
        @keyframes slideInRight { 
            from { transform: translateX(100px); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }

        @keyframes markerDrop {
            0% { transform: translateY(-200px) scale(0.5); opacity: 0; }
            60% { transform: translateY(10px) scale(1.1); opacity: 1; }
            80% { transform: translateY(-5px) scale(0.95); }
            100% { transform: translateY(0) scale(1); }
        }

        .marker-animate {
            animation: markerDrop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* Loading å‹•ç•« */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            animation: fadeOut 0.5s ease 2s forwards;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6f4e37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeOut {
            to { opacity: 0; pointer-events: none; }
        }

        .loading-text {
            color: #6f4e37;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* RWD æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media (max-width: 768px) {
            .title-panel { 
                top: 10px; 
                left: 10px; 
                right: 10px; 
                max-width: none; 
                padding: 16px;
            }
            
            .title-panel h1 {
                font-size: 1.3rem;
            }

            .subtitle {
                display: none;
            }
            
            .filter-control { 
                top: auto; 
                bottom: 15px; 
                right: 10px; 
                left: 10px; 
                flex-direction: row; 
                overflow-x: auto; 
                padding: 10px;
                gap: 8px;
                scrollbar-width: none;
            }

            .filter-control::-webkit-scrollbar {
                display: none;
            }

            .filter-control h3 {
                display: none;
            }
            
            .filter-btn { 
                flex: 0 0 auto; 
                padding: 8px 14px; 
                font-size: 0.85rem;
                white-space: nowrap;
            }
            
            .filter-btn.active { 
                transform: translateY(-3px);
            }

            .count-badge {
                font-size: 0.7rem;
                padding: 2px 6px;
            }

            .leaflet-popup-content {
                width: 260px !important;
            }
        }

        /* æš—è‰²æ¨¡å¼æ”¯æ´ (å¯é¸) */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
            }

            .title-panel {
                background: linear-gradient(135deg, #2c2c2c 0%, #252525 100%);
                color: #e0e0e0;
            }

            .title-panel h1 {
                color: #d4a574;
            }

            .title-panel p {
                color: #b0b0b0;
            }

            .filter-control {
                background: rgba(44, 44, 44, 0.97);
            }

            .filter-btn {
                color: #e0e0e0;
            }

            .filter-btn:hover {
                background: #3a3a3a;
            }
        }

        /* --- æ–°å¢å’–å•¡åº—æŒ‰éˆ• --- */
        .add-shop-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6f4e37 0%, #5a3d2d 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(111, 78, 55, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-shop-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 24px rgba(111, 78, 55, 0.6);
        }

        /* --- è¡¨å–®æ¨¡æ…‹è¦–çª— --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #6f4e37 0%, #5a3d2d 100%);
            color: white;
            padding: 24px 28px;
            border-radius: 20px 20px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #6f4e37;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-help {
            font-size: 0.85rem;
            color: #888;
            margin-top: 6px;
        }

        .features-input-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .feature-input-row {
            display: flex;
            gap: 8px;
        }

        .feature-input-row input {
            flex: 1;
        }

        .feature-input-row button {
            padding: 8px 12px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .feature-input-row button:hover {
            background: #e0e0e0;
        }

        .add-feature-btn {
            padding: 10px 16px;
            background: #6f4e37;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s ease;
        }

        .add-feature-btn:hover {
            background: #5a3d2d;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }

        .btn-primary,
        .btn-secondary {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2c8e3c 0%, #27753a 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #27753a 0%, #1e5a2d 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 142, 60, 0.3);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #555;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* æ‰‹æ©Ÿç‰ˆè¡¨å–®å„ªåŒ– */
        @media (max-width: 768px) {
            .add-shop-btn {
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
            }

            .add-shop-btn:hover {
                transform: translateX(-50%) scale(1.1) rotate(90deg);
            }

            .modal-content {
                width: 95%;
                max-height: 85vh;
            }

            .modal-body {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }
        }

        /* --- ä½œè€… Footer --- */
        .author-footer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.92);
            padding: 10px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 999;
            font-size: 0.85rem;
            color: #555;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .author-footer:hover {
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .author-footer a {
            color: #6f4e37;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s ease;
        }

        .author-footer a:hover {
            color: #5a3d2d;
        }

        .author-footer i {
            font-size: 1rem;
        }

        /* æ‰‹æ©Ÿç‰ˆ Footer å„ªåŒ– */
        @media (max-width: 768px) {
            .author-footer {
                bottom: 10px;
                right: 10px;
                left: 10px;
                justify-content: center;
                font-size: 0.8rem;
                padding: 8px 12px;
            }
        }

        /* --- èªè¨€åˆ‡æ›æŒ‰éˆ• --- */
        .language-switcher {
            position: absolute;
            top: 20px;
            left: 340px;
            background: linear-gradient(135deg, #ffffff 0%, #f9f9f9 100%);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            gap: 6px;
            animation: slideInLeft 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.2s both;
            backdrop-filter: blur(10px);
        }

        .lang-btn {
            background: transparent;
            border: 2px solid #e0e0e0;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .lang-btn:hover {
            border-color: #6f4e37;
            background: #f5f5f5;
            transform: translateY(-2px);
        }

        .lang-btn.active {
            background: linear-gradient(135deg, #6f4e37 0%, #5a3d2d 100%);
            color: white;
            border-color: #6f4e37;
            box-shadow: 0 4px 12px rgba(111, 78, 55, 0.3);
        }

        .lang-btn i {
            font-size: 1rem;
        }

        /* æ‰‹æ©Ÿç‰ˆèªè¨€åˆ‡æ›å™¨ */
        @media (max-width: 768px) {
            .language-switcher {
                top: auto;
                bottom: 60px;
                left: 50%;
                transform: translateX(-50%);
                gap: 4px;
                padding: 8px;
            }

            .lang-btn {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>

    <!-- Loading å‹•ç•« -->
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ğŸ—ºï¸ æ­£åœ¨æº–å‚™ç¾é£Ÿåœ°åœ–...</div>
    </div>

    <div class="title-panel">
        <h1><i class="fas fa-map-marked-alt"></i> <span id="page-title">Corvallis ç¾é£Ÿåœ°åœ–</span></h1>
        <p id="page-subtitle">æ¢ç´¢ Corvallis æœ€æ£’çš„å’–å•¡åº—èˆ‡é¤å»³ï¼é¸æ“‡å³å´é¸å–®ç¯©é¸ä½ æƒ³è¦çš„é¡åˆ¥ã€‚</p>
        <div class="subtitle" id="page-hint">ğŸ¯ é»æ“Šåœ°åœ–æ¨™è¨˜æŸ¥çœ‹è©³ç´°è³‡è¨Š</div>
    </div>

    <!-- èªè¨€åˆ‡æ›å™¨ -->
    <div class="language-switcher">
        <button class="lang-btn active" onclick="switchLanguage('zh')" id="lang-zh">
            <span>ğŸ‡¹ğŸ‡¼</span>
            <span>ä¸­æ–‡</span>
        </button>
        <button class="lang-btn" onclick="switchLanguage('en')" id="lang-en">
            <span>ğŸ‡ºğŸ‡¸</span>
            <span>English</span>
        </button>
    </div>

    <div class="filter-control">
        <h3 id="filter-main-title">ä¸»é¡åˆ¥</h3>
        <button class="filter-btn active" data-category="all" data-type="main" onclick="filterMarkers('all')">
            <i class="fas fa-layer-group"></i>
            <span class="filter-text" data-i18n="filter.all">å…¨éƒ¨é¡¯ç¤º</span>
            <span class="count-badge" id="count-all">0</span>
        </button>
        <button class="filter-btn" data-category="coffee" data-type="main" onclick="filterMarkers('coffee')">
            <i class="fas fa-mug-hot"></i>
            <span class="filter-text" data-i18n="filter.coffee">å’–å•¡åº—</span>
            <span class="count-badge" id="count-coffee">0</span>
        </button>
        <button class="filter-btn" data-category="restaurant" data-type="main" onclick="filterMarkers('restaurant')">
            <i class="fas fa-utensils"></i>
            <span class="filter-text" data-i18n="filter.restaurant">é¤å»³</span>
            <span class="count-badge" id="count-restaurant">0</span>
        </button>

        <div id="coffeeSubcategories" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0;">
            <h3 id="filter-coffee-title">å’–å•¡åº—é¡å‹</h3>
            <button class="filter-btn" data-category="aesthetic" data-type="coffee" onclick="filterMarkers('aesthetic')">
                <i class="fas fa-leaf icon-aesthetic"></i>
                <span class="filter-text" data-i18n="filter.aesthetic">æ°£æ°›ç¾æ„Ÿ</span>
                <span class="count-badge" id="count-aesthetic">0</span>
            </button>
            <button class="filter-btn" data-category="study" data-type="coffee" onclick="filterMarkers('study')">
                <i class="fas fa-laptop icon-study"></i>
                <span class="filter-text" data-i18n="filter.study">è®€æ›¸å·¥ä½œ</span>
                <span class="count-badge" id="count-study">0</span>
            </button>
            <button class="filter-btn" data-category="nerd" data-type="coffee" onclick="filterMarkers('nerd')">
                <i class="fas fa-glasses icon-nerd"></i>
                <span class="filter-text" data-i18n="filter.nerd">å’–å•¡è¡Œå®¶</span>
                <span class="count-badge" id="count-nerd">0</span>
            </button>
            <button class="filter-btn" data-category="community" data-type="coffee" onclick="filterMarkers('community')">
                <i class="fas fa-users icon-community"></i>
                <span class="filter-text" data-i18n="filter.community">æº«é¦¨èšæœƒ</span>
                <span class="count-badge" id="count-community">0</span>
            </button>
        </div>

        <div id="restaurantSubcategories" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0;">
            <h3 id="filter-restaurant-title">é¤å»³é¡å‹</h3>
            <button class="filter-btn" data-category="mexican" data-type="restaurant" onclick="filterMarkers('mexican')">
                <i class="fas fa-pepper-hot" style="color: #dc2626;"></i>
                <span class="filter-text" data-i18n="filter.mexican">å¢¨è¥¿å“¥</span>
                <span class="count-badge" id="count-mexican">0</span>
            </button>
            <button class="filter-btn" data-category="chinese" data-type="restaurant" onclick="filterMarkers('chinese')">
                <i class="fas fa-dragon" style="color: #dc2626;"></i>
                <span class="filter-text" data-i18n="filter.chinese">ä¸­å¼</span>
                <span class="count-badge" id="count-chinese">0</span>
            </button>
            <button class="filter-btn" data-category="middle-eastern" data-type="restaurant" onclick="filterMarkers('middle-eastern')">
                <i class="fas fa-mosque" style="color: #059669;"></i>
                <span class="filter-text" data-i18n="filter.middleEastern">ä¸­æ±</span>
                <span class="count-badge" id="count-middle-eastern">0</span>
            </button>
            <button class="filter-btn" data-category="korean" data-type="restaurant" onclick="filterMarkers('korean')">
                <i class="fas fa-fire" style="color: #dc2626;"></i>
                <span class="filter-text" data-i18n="filter.korean">éŸ“å¼</span>
                <span class="count-badge" id="count-korean">0</span>
            </button>
            <button class="filter-btn" data-category="european" data-type="restaurant" onclick="filterMarkers('european')">
                <i class="fas fa-wine-glass" style="color: #7c3aed;"></i>
                <span class="filter-text" data-i18n="filter.european">æ­ç¾</span>
                <span class="count-badge" id="count-european">0</span>
            </button>
            <button class="filter-btn" data-category="pizza" data-type="restaurant" onclick="filterMarkers('pizza')">
                <i class="fas fa-pizza-slice" style="color: #ea580c;"></i>
                <span class="filter-text" data-i18n="filter.pizza">æŠ«è–©</span>
                <span class="count-badge" id="count-pizza">0</span>
            </button>
            <button class="filter-btn" data-category="sandwich" data-type="restaurant" onclick="filterMarkers('sandwich')">
                <i class="fas fa-hamburger" style="color: #c2410c;"></i>
                <span class="filter-text" data-i18n="filter.sandwich">ä¸‰æ˜æ²»/æ¼¢å ¡</span>
                <span class="count-badge" id="count-sandwich">0</span>
            </button>
            <button class="filter-btn" data-category="bar" data-type="restaurant" onclick="filterMarkers('bar')">
                <i class="fas fa-beer" style="color: #d97706;"></i>
                <span class="filter-text" data-i18n="filter.bar">é…’å§</span>
                <span class="count-badge" id="count-bar">0</span>
            </button>
            <button class="filter-btn" data-category="indian" data-type="restaurant" onclick="filterMarkers('indian')">
                <i class="fas fa-om" style="color: #ea580c;"></i>
                <span class="filter-text" data-i18n="filter.indian">å°åº¦</span>
                <span class="count-badge" id="count-indian">0</span>
            </button>
            <button class="filter-btn" data-category="thai" data-type="restaurant" onclick="filterMarkers('thai')">
                <i class="fas fa-leaf" style="color: #16a34a;"></i>
                <span class="filter-text" data-i18n="filter.thai">æ³°å¼</span>
                <span class="count-badge" id="count-thai">0</span>
            </button>
        </div>
    </div>

    <div id="map"></div>

    <!-- ä½œè€… Footer -->
    <div class="author-footer">
        <span id="author-text">Made by</span>
        <a href="https://github.com/Ben0126" target="_blank" rel="noopener noreferrer">
            <i class="fab fa-github"></i>
            Ben0126
        </a>
    </div>

    <!-- æ–°å¢å’–å•¡åº—/é¤å»³æŒ‰éˆ• -->
    <button class="add-shop-btn" onclick="openModal()">
        <i class="fas fa-plus"></i>
    </button>

    <!-- è¡¨å–®æ¨¡æ…‹è¦–çª— -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-map-marker-alt"></i> æ–°å¢åœ°é»</h2>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="coffeeShopForm" onsubmit="submitForm(event)">
                    <div class="form-group">
                        <label for="placeType">é¡å‹ *</label>
                        <select id="placeType" name="placeType" required onchange="updateCategoryOptions()">
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="coffee">å’–å•¡åº—</option>
                            <option value="restaurant">é¤å»³</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="shopName">åç¨± *</label>
                        <input type="text" id="shopName" name="shopName" required placeholder="ä¾‹å¦‚ï¼šGreenhouse Coffee + Plants">
                    </div>

                    <div class="form-group">
                        <label for="category">é¡åˆ¥ *</label>
                        <select id="category" name="category" required onchange="updateIconByCategory()">
                            <option value="">è«‹å…ˆé¸æ“‡é¡å‹...</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="latitude">ç·¯åº¦ (Latitude) *</label>
                            <input type="number" id="latitude" name="latitude" step="any" required placeholder="44.5643">
                            <div class="form-help">å¯å¾ Google Maps å–å¾—</div>
                        </div>
                        <div class="form-group">
                            <label for="longitude">ç¶“åº¦ (Longitude) *</label>
                            <input type="number" id="longitude" name="longitude" step="any" required placeholder="-123.2614">
                            <div class="form-help">å¯å¾ Google Maps å–å¾—</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="icon">åœ–ç¤ºåç¨± *</label>
                        <input type="text" id="icon" name="icon" required placeholder="ä¾‹å¦‚ï¼šleaf, coffee, book">
                        <div class="form-help">ä½¿ç”¨ Font Awesome åœ–ç¤ºåç¨±ï¼ˆä¸å« fa-ï¼‰</div>
                    </div>

                    <div class="form-group">
                        <label for="description">è©³ç´°æè¿° *</label>
                        <textarea id="description" name="description" required placeholder="æè¿°å’–å•¡åº—çš„ç‰¹è‰²ã€æ°›åœã€æ¨è–¦é£²å“ç­‰..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>ç‰¹è‰²æ¨™ç±¤</label>
                        <div class="features-input-container" id="featuresContainer">
                            <div class="feature-input-row">
                                <input type="text" placeholder="ä¾‹å¦‚ï¼šğŸ“¸ é©åˆæ‹ç…§" class="feature-input">
                                <button type="button" onclick="removeFeature(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="add-feature-btn" onclick="addFeatureInput()">
                            <i class="fas fa-plus"></i> æ–°å¢æ¨™ç±¤
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="googleMapsLink">Google Maps é€£çµ</label>
                        <input type="url" id="googleMapsLink" name="googleMapsLink" placeholder="https://www.google.com/maps/place/...">
                        <div class="form-help">é¸å¡«ï¼šå¾ Google Maps è¤‡è£½åˆ†äº«é€£çµ</div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-check"></i> æäº¤
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- 0. èªè¨€ç³»çµ± (i18n) ---
        let currentLanguage = localStorage.getItem('preferredLanguage') || 'zh';

        const i18n = {
            zh: {
                title: 'Corvallis ç¾é£Ÿåœ°åœ–',
                subtitle: 'æ¢ç´¢ Corvallis æœ€æ£’çš„å’–å•¡åº—èˆ‡é¤å»³ï¼é¸æ“‡å³å´é¸å–®ç¯©é¸ä½ æƒ³è¦çš„é¡åˆ¥ã€‚',
                hint: 'ğŸ¯ é»æ“Šåœ°åœ–æ¨™è¨˜æŸ¥çœ‹è©³ç´°è³‡è¨Š',
                loading: 'ğŸ—ºï¸ æ­£åœ¨æº–å‚™ç¾é£Ÿåœ°åœ–...',
                filter: {
                    mainTitle: 'ä¸»é¡åˆ¥',
                    coffeeTitle: 'å’–å•¡åº—é¡å‹',
                    restaurantTitle: 'é¤å»³é¡å‹',
                    all: 'å…¨éƒ¨é¡¯ç¤º',
                    coffee: 'å’–å•¡åº—',
                    restaurant: 'é¤å»³',
                    aesthetic: 'æ°£æ°›ç¾æ„Ÿ',
                    study: 'è®€æ›¸å·¥ä½œ',
                    nerd: 'å’–å•¡è¡Œå®¶',
                    community: 'æº«é¦¨èšæœƒ',
                    mexican: 'å¢¨è¥¿å“¥',
                    chinese: 'ä¸­å¼',
                    middleEastern: 'ä¸­æ±',
                    korean: 'éŸ“å¼',
                    european: 'æ­ç¾',
                    pizza: 'æŠ«è–©',
                    sandwich: 'ä¸‰æ˜æ²»/æ¼¢å ¡',
                    bar: 'é…’å§',
                    indian: 'å°åº¦',
                    thai: 'æ³°å¼'
                },
                popup: {
                    openInMaps: 'åœ¨ Google Maps ä¸­é–‹å•Ÿ'
                },
                form: {
                    title: 'æ–°å¢åœ°é»',
                    placeType: 'é¡å‹',
                    placeTypeSelect: 'è«‹é¸æ“‡...',
                    coffee: 'å’–å•¡åº—',
                    restaurant: 'é¤å»³',
                    name: 'åç¨±',
                    namePlaceholder: 'ä¾‹å¦‚ï¼šGreenhouse Coffee + Plants',
                    category: 'é¡åˆ¥',
                    categorySelect: 'è«‹å…ˆé¸æ“‡é¡å‹...',
                    latitude: 'ç·¯åº¦ (Latitude)',
                    latPlaceholder: '44.5643',
                    latHelp: 'å¯å¾ Google Maps å–å¾—',
                    longitude: 'ç¶“åº¦ (Longitude)',
                    lngPlaceholder: '-123.2614',
                    lngHelp: 'å¯å¾ Google Maps å–å¾—',
                    icon: 'åœ–ç¤ºåç¨±',
                    iconPlaceholder: 'ä¾‹å¦‚ï¼šleaf, coffee, book',
                    iconHelp: 'ä½¿ç”¨ Font Awesome åœ–ç¤ºåç¨±ï¼ˆä¸å« fa-ï¼‰',
                    description: 'è©³ç´°æè¿°',
                    descPlaceholder: 'æè¿°å’–å•¡åº—çš„ç‰¹è‰²ã€æ°›åœã€æ¨è–¦é£²å“ç­‰...',
                    features: 'ç‰¹è‰²æ¨™ç±¤',
                    featurePlaceholder: 'ä¾‹å¦‚ï¼šğŸ“¸ é©åˆæ‹ç…§',
                    addFeature: 'æ–°å¢æ¨™ç±¤',
                    googleMaps: 'Google Maps é€£çµ',
                    googleMapsPlaceholder: 'https://www.google.com/maps/place/...',
                    googleMapsHelp: 'é¸å¡«ï¼šå¾ Google Maps è¤‡è£½åˆ†äº«é€£çµ',
                    cancel: 'å–æ¶ˆ',
                    submit: 'æäº¤',
                    required: 'å¿…å¡«æ¬„ä½',
                    categoryOptions: {
                        aesthetic: 'æ°£æ°›ç¾æ„Ÿ - é©åˆæ‹ç…§ã€ç’°å¢ƒå„ªç¾',
                        study: 'è®€æ›¸å·¥ä½œ - æ’åº§å¤šã€é©åˆå­¸ç¿’',
                        nerd: 'å’–å•¡è¡Œå®¶ - å°ˆæ³¨å’–å•¡å“è³ª',
                        community: 'æº«é¦¨èšæœƒ - ç¤¾å€å‹å–„ã€é©åˆèšæœƒ',
                        mexican: 'å¢¨è¥¿å“¥æ–™ç†',
                        chinese: 'ä¸­å¼æ–™ç†',
                        middleEastern: 'ä¸­æ±æ–™ç†',
                        korean: 'éŸ“å¼æ–™ç†',
                        european: 'æ­ç¾æ–™ç†',
                        pizza: 'æŠ«è–©',
                        sandwich: 'ä¸‰æ˜æ²»/æ¼¢å ¡',
                        bar: 'é…’å§',
                        indian: 'å°åº¦æ–™ç†',
                        thai: 'æ³°å¼æ–™ç†'
                    }
                },
                author: {
                    madeBy: 'Made by'
                }
            },
            en: {
                title: 'Corvallis Food Map',
                subtitle: 'Discover the best coffee shops and restaurants in Corvallis! Use the filter menu to browse categories.',
                hint: 'ğŸ¯ Click map markers for details',
                loading: 'ğŸ—ºï¸ Loading food map...',
                filter: {
                    mainTitle: 'Main Category',
                    coffeeTitle: 'Coffee Shop Types',
                    restaurantTitle: 'Restaurant Types',
                    all: 'Show All',
                    coffee: 'Coffee Shops',
                    restaurant: 'Restaurants',
                    aesthetic: 'Aesthetic',
                    study: 'Study/Work',
                    nerd: 'Coffee Connoisseur',
                    community: 'Community',
                    mexican: 'Mexican',
                    chinese: 'Chinese',
                    middleEastern: 'Middle Eastern',
                    korean: 'Korean',
                    european: 'European/American',
                    pizza: 'Pizza',
                    sandwich: 'Sandwich/Burger',
                    bar: 'Bar',
                    indian: 'Indian',
                    thai: 'Thai'
                },
                popup: {
                    openInMaps: 'Open in Google Maps'
                },
                form: {
                    title: 'Add New Place',
                    placeType: 'Type',
                    placeTypeSelect: 'Please select...',
                    coffee: 'Coffee Shop',
                    restaurant: 'Restaurant',
                    name: 'Name',
                    namePlaceholder: 'e.g., Greenhouse Coffee + Plants',
                    category: 'Category',
                    categorySelect: 'Please select type first...',
                    latitude: 'Latitude',
                    latPlaceholder: '44.5643',
                    latHelp: 'Get from Google Maps',
                    longitude: 'Longitude',
                    lngPlaceholder: '-123.2614',
                    lngHelp: 'Get from Google Maps',
                    icon: 'Icon Name',
                    iconPlaceholder: 'e.g., leaf, coffee, book',
                    iconHelp: 'Use Font Awesome icon name (without fa-)',
                    description: 'Description',
                    descPlaceholder: 'Describe the place, atmosphere, recommended items, etc...',
                    features: 'Feature Tags',
                    featurePlaceholder: 'e.g., ğŸ“¸ Instagrammable',
                    addFeature: 'Add Tag',
                    googleMaps: 'Google Maps Link',
                    googleMapsPlaceholder: 'https://www.google.com/maps/place/...',
                    googleMapsHelp: 'Optional: Copy share link from Google Maps',
                    cancel: 'Cancel',
                    submit: 'Submit',
                    required: '*',
                    categoryOptions: {
                        aesthetic: 'Aesthetic - Great for photos, beautiful ambiance',
                        study: 'Study/Work - Plenty of outlets, study-friendly',
                        nerd: 'Coffee Connoisseur - Focus on quality coffee',
                        community: 'Community - Friendly, great for gatherings',
                        mexican: 'Mexican Cuisine',
                        chinese: 'Chinese Cuisine',
                        middleEastern: 'Middle Eastern Cuisine',
                        korean: 'Korean Cuisine',
                        european: 'European/American Cuisine',
                        pizza: 'Pizza',
                        sandwich: 'Sandwich/Burger',
                        bar: 'Bar',
                        indian: 'Indian Cuisine',
                        thai: 'Thai Cuisine'
                    }
                },
                author: {
                    madeBy: 'Made by'
                }
            }
        };

        // èªè¨€åˆ‡æ›å‡½æ•¸
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang);

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`lang-${lang}`).classList.add('active');

            // æ›´æ–°æ‰€æœ‰æ–‡æœ¬
            updateAllTexts();
        }

        // æ›´æ–°æ‰€æœ‰æ–‡æœ¬
        function updateAllTexts() {
            const t = i18n[currentLanguage];

            // æ›´æ–°é é¢æ¨™é¡Œå’Œæç¤º
            document.getElementById('page-title').textContent = t.title;
            document.getElementById('page-subtitle').textContent = t.subtitle;
            document.getElementById('page-hint').textContent = t.hint;
            document.querySelector('.loading-text').textContent = t.loading;

            // æ›´æ–°ç¯©é¸æ¨™é¡Œ
            document.getElementById('filter-main-title').textContent = t.filter.mainTitle;
            document.getElementById('filter-coffee-title').textContent = t.filter.coffeeTitle;
            document.getElementById('filter-restaurant-title').textContent = t.filter.restaurantTitle;

            // æ›´æ–°æ‰€æœ‰ç¯©é¸æŒ‰éˆ•
            document.querySelectorAll('[data-i18n]').forEach(elem => {
                const key = elem.getAttribute('data-i18n');
                const keys = key.split('.');
                let value = t;
                keys.forEach(k => value = value[k]);
                elem.textContent = value;
            });

            // æ›´æ–°ä½œè€…æ–‡æœ¬
            document.getElementById('author-text').textContent = t.author.madeBy;

            // æ›´æ–°è¡¨å–®
            updateFormTexts();

            // æ›´æ–°é é¢æ¨™é¡Œ (ç€è¦½å™¨æ¨™ç±¤)
            document.title = t.title + ' ğŸ—ºï¸';
        }

        // æ›´æ–°è¡¨å–®æ–‡æœ¬
        function updateFormTexts() {
            const t = i18n[currentLanguage].form;

            // è¡¨å–®æ¨™é¡Œ
            document.querySelector('.modal-header h2').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${t.title}`;

            // æ›´æ–°è¡¨å–®å­—æ®µ
            document.querySelector('label[for="placeType"]').innerHTML = `${t.placeType} <span style="color: red;">*</span>`;
            document.querySelector('#placeType option[value=""]').textContent = t.placeTypeSelect;
            document.querySelector('#placeType option[value="coffee"]').textContent = t.coffee;
            document.querySelector('#placeType option[value="restaurant"]').textContent = t.restaurant;

            document.querySelector('label[for="shopName"]').innerHTML = `${t.name} <span style="color: red;">*</span>`;
            document.getElementById('shopName').placeholder = t.namePlaceholder;

            document.querySelector('label[for="category"]').innerHTML = `${t.category} <span style="color: red;">*</span>`;

            document.querySelector('label[for="latitude"]').innerHTML = `${t.latitude} <span style="color: red;">*</span>`;
            document.getElementById('latitude').placeholder = t.latPlaceholder;
            document.querySelectorAll('.form-help')[0].textContent = t.latHelp;

            document.querySelector('label[for="longitude"]').innerHTML = `${t.longitude} <span style="color: red;">*</span>`;
            document.getElementById('longitude').placeholder = t.lngPlaceholder;
            document.querySelectorAll('.form-help')[1].textContent = t.lngHelp;

            document.querySelector('label[for="icon"]').innerHTML = `${t.icon} <span style="color: red;">*</span>`;
            document.getElementById('icon').placeholder = t.iconPlaceholder;
            document.querySelectorAll('.form-help')[2].textContent = t.iconHelp;

            document.querySelector('label[for="description"]').innerHTML = `${t.description} <span style="color: red;">*</span>`;
            document.getElementById('description').placeholder = t.descPlaceholder;

            document.querySelector('.form-group label:nth-of-type(7)').textContent = t.features;
            document.querySelectorAll('.feature-input').forEach(input => {
                input.placeholder = t.featurePlaceholder;
            });
            document.querySelector('.add-feature-btn').innerHTML = `<i class="fas fa-plus"></i> ${t.addFeature}`;

            document.querySelector('label[for="googleMapsLink"]').textContent = t.googleMaps;
            document.getElementById('googleMapsLink').placeholder = t.googleMapsPlaceholder;
            document.querySelectorAll('.form-help')[3].textContent = t.googleMapsHelp;

            document.querySelector('.btn-secondary').textContent = t.cancel;
            document.querySelector('.btn-primary').innerHTML = `<i class="fas fa-check"></i> ${t.submit}`;

            // æ›´æ–°é¡åˆ¥é¸é …ï¼ˆå¦‚æœå·²é¸æ“‡é¡å‹ï¼‰
            const placeType = document.getElementById('placeType').value;
            if (placeType) {
                updateCategoryOptions();
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–èªè¨€
        document.addEventListener('DOMContentLoaded', function() {
            // è¨­ç½®åˆå§‹èªè¨€
            switchLanguage(currentLanguage);
        });

        // --- 1. è©³ç´°åº—å®¶è³‡æ–™åº« ---
        const defaultPlaces = [
            // --- â˜• å’–å•¡åº— (Coffee Shops) ---
            {
                id: 1,
                name: "Greenhouse Coffee + Plants",
                type: "coffee",
                category: "aesthetic",
                lat: 44.5643,
                lng: -123.2614,
                icon: "leaf",
                desc: "è¢«æ¤ç‰©åŒ…åœçš„æº«å®¤å’–å•¡å»³ï¼Œå…‰ç·šéå¸¸å……è¶³ã€‚åº—å…§åŒæ™‚è²©å”®ç²¾é¸æ¤æ ½ï¼Œæ°›åœæ¸…æ–°è‡ªç„¶ï¼Œæ˜¯æ”¾é¬†å¿ƒæƒ…çš„çµ•ä½³å»è™•ã€‚",
                features: ["ğŸ“¸ é©åˆæ‹ç…§", "ğŸŒ± æœ‰è³£æ¤ç‰©", "â˜€ï¸ æ¡å…‰ä½³", "ğŸƒ æ¤æ ½è²©å”®"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJi3lah6xBwFQRnmEChZrqk1g"
            },
            {
                id: 2,
                name: "Futura Coffee Roasters",
                type: "coffee",
                category: "aesthetic",
                lat: 44.5629,
                lng: -123.2601,
                icon: "seedling",
                desc: "å‰èº«ç‚º Tried & Trueã€‚ç¾ä»£å·¥æ¥­é¢¨è¨­è¨ˆï¼Œå°ˆæ³¨æ–¼æ°¸çºŒè¾²æ¥­èˆ‡é«˜å“è³ªæ‰‹æ²–ã€‚æ¯ä¸€æ¯å’–å•¡éƒ½æ˜¯è—è¡“å“ï¼Œæ³¨é‡ç”¢åœ°èˆ‡é¢¨å‘³ã€‚",
                features: ["â˜• æ‰‹æ²–å’–å•¡", "ğŸ§± å·¥æ¥­é¢¨", "ğŸŒ æ°¸çºŒç’°ä¿", "ğŸ¥¯ è¼•é£Ÿç”œé»"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJgwQZuutAwFQR_hYeRaEI8Tk"
            },
            {
                id: 3,
                name: "Interzone",
                type: "coffee",
                category: "study",
                lat: 44.5677,
                lng: -123.2738,
                icon: "guitar",
                desc: "æ ¡å€æ—çš„é¾å…‹æ–æ»¾é¢¨æ ¼åº—ã€‚ç‡Ÿæ¥­æ™‚é–“è¼ƒæ™šï¼Œé©åˆéœ€è¦ç‰¹æ®Šéˆæ„Ÿæˆ–ç†¬å¤œè®€æ›¸çš„æ™‚å€™ã€‚æœ‰æ©Ÿç‡•éº¥ç²¥å’Œè²æœæ˜¯å­¸ç”Ÿæœ€æ„›ã€‚",
                features: ["ğŸ¸ æ–æ»¾Vibe", "ğŸ¦‰ é–‹åˆ°è¼ƒæ™š", "ğŸ¥£ æœ‰æ©Ÿç‡•éº¥ç²¥", "ğŸ“ è¿‘æ ¡åœ’"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJZ0Gk571AwFQR3i_43l-BJkI"
            },
            {
                id: 4,
                name: "Coffee Culture (Kings)",
                type: "coffee",
                category: "study",
                lat: 44.5778,
                lng: -123.2748,
                icon: "book",
                desc: "ç©ºé–“å¯¬æ•ã€åº§ä½å¤šä¸”æ’åº§å……è¶³ï¼Œæ˜¯è¨±å¤š OSU å­¸ç”Ÿè¶•è«–æ–‡çš„ç§˜å¯†åŸºåœ°ã€‚è‡ªå®¶çƒ˜ç„™çš„é»å¿ƒå’Œä¸‰æ˜æ²»ä¹Ÿå¾ˆå—æ­¡è¿ã€‚",
                features: ["ğŸ’» æ’åº§å¤š", "ğŸ“š é©åˆè®€æ›¸", "ğŸ¥ª ä¸‰æ˜æ²»", "ğŸš— åœè»Šæ–¹ä¾¿"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJK8GsEZxAwFQRwjxaGThm9lU"
            },
            {
                id: 5,
                name: "Oregon Coffee & Tea",
                type: "coffee",
                category: "nerd",
                lat: 44.5650,
                lng: -123.2595,
                icon: "coffee",
                desc: "æ•¸åå¹´è€åº—ï¼Œå°ˆæ³¨æ–¼è²©å”®æ–°é®®çƒ˜ç„™è±†èˆ‡èŒ¶è‘‰ï¼Œè¡Œå®¶å¿…å»ã€‚ä¸€èµ°é€²å»å°±æœƒè¢«æ¿ƒéƒçš„è±†å­é¦™æ°£åŒ…åœã€‚",
                features: ["ğŸ›ï¸ è²·è±†é¦–é¸", "ğŸ‘ƒ é¦™æ°£å››æº¢", "ğŸµ èŒ¶è‘‰å°ˆè³£", "ğŸ“œ è€å­—è™Ÿ"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJu3p_dutAwFQRnqeobhWXnuU"
            },
            {
                id: 6,
                name: "Imagine Coffee Co.",
                type: "coffee",
                category: "community",
                lat: 44.5501,
                lng: -123.3130,
                icon: "music",
                desc: "åƒæ˜¯ç¤¾å€å®¢å»³ä¸€æ¨£æº«æš–ï¼Œå¸¸æœ‰ç¾å ´éŸ³æ¨‚æ¼”å¥èˆ‡è—è¡“å±•è¦½ã€‚ä½æ–¼ Philomath æ–¹å‘ï¼Œæ˜¯ä¸€å€‹é é›¢å¡µå›‚çš„æº«é¦¨è§’è½ã€‚",
                features: ["ğŸ¨ è—è¡“å±•è¦½", "ğŸµ ç¾å ´éŸ³æ¨‚", "ğŸ›‹ï¸ æ²™ç™¼å€", "ğŸ˜ï¸ ç¤¾å€æ„Ÿ"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJhffwvEBHwFQRLy-xUiAV0GY"
            },
            {
                id: 7,
                name: "Bodhi Cafe & Bakery",
                type: "coffee",
                category: "community",
                lat: 44.5600,
                lng: -123.2622,
                icon: "bread-slice",
                desc: "éºµåŒ…æ˜¯æœ¬é«”ï¼ä½¿ç”¨åœ¨åœ°é£Ÿæè£½ä½œçš„æ—©åˆé¤éå¸¸å—æ­¡è¿ã€‚è±†è”»æ‹¿éµæ­é…å‰›å‡ºçˆçš„éºµåŒ…æ˜¯çµ•é…ã€‚æœ‰æˆ¶å¤–åº§ä½ã€‚",
                features: ["ğŸ¥ è¶…å¼·éºµåŒ…", "ğŸ¥ª æ—©åˆé¤", "ğŸŒ æˆ¶å¤–åº§ä½", "ğŸ¥¬ åœ¨åœ°é£Ÿæ"],
                link: "https://www.google.com/maps/place/?q=place_id:ChIJww_2m3VBwFQRfyir2HHDTsE"
            },

            // --- ğŸ‡²ğŸ‡½ é¤å»³ - å¢¨è¥¿å“¥æ–™ç† (Mexican) ---
            {
                id: 101,
                name: "Oscar's Tacos and Cantina",
                type: "restaurant",
                category: "mexican",
                lat: 44.5922,
                lng: -123.2523,
                icon: "pepper-hot",
                desc: "é«˜å“è³ªã€ç¾å‘³ä¸”ä»½é‡å……è¶³çš„å¢¨è¥¿å“¥æ–™ç†ã€‚Gobernador æ²é¤…å’Œ Carnitas æ˜¯å¿…é»ã€‚ç”œé»æ³•è˜­ (Flan) çµ•å°ä¸èƒ½éŒ¯éã€‚",
                features: ["â­ 4.9 æ˜Ÿ", "ğŸŒ® å¿…åƒæ²é¤…", "ğŸ® æ³•è˜­ç”œé»", "ğŸš— åœè»Šæ–¹ä¾¿"],
                link: "https://maps.google.com/?q=Oscar's+Tacos+and+Cantina+Corvallis"
            },
            {
                id: 102,
                name: "El charro negro",
                type: "restaurant",
                category: "mexican",
                lat: 44.5803,
                lng: -123.2601,
                icon: "pepper-hot",
                desc: "æ­£å®—å¢¨è¥¿å“¥é¢¨å‘³ï¼Œä»½é‡æ¥µå¤§ï¼æ‹›ç‰Œæ¨è–¦ Quesabirria (æ²¾è‚‰æ¹¯åƒ) å’Œ Pollo Locoã€‚å¤§å­¸ç”Ÿå‡ºç¤ºè­‰ä»¶å¸¸æœ‰å„ªæƒ ã€‚",
                features: ["â­ 4.7 æ˜Ÿ", "ğŸ¥˜ Quesabirria", "ğŸ¹ ç„¡é…’ç²¾ç‰¹èª¿", "ğŸ“ å­¸ç”Ÿå„ªæƒ "],
                link: "https://maps.google.com/?q=El+Charro+Negro+Corvallis"
            },

            // --- ğŸ‡¨ğŸ‡³ é¤å»³ - ä¸­å¼æ–™ç† (Chinese) ---
            {
                id: 103,
                name: "Tian Fu Noodle (å¤©åºœéºµé£Ÿ)",
                type: "restaurant",
                category: "chinese",
                lat: 44.5675,
                lng: -123.2724,
                icon: "fire",
                desc: "ä½æ–¼æ ¡åœ’æ—çš„æº«é¦¨å°åº—ã€‚ä¸»æ‰“æ‰‹å·¥éºµé£Ÿå’Œå‰µæ„ã€ŒDIY å€‹äººç«é‹ã€ï¼Œéº»é†¬æ¹¯åº•éå¸¸æ¿ƒéƒã€‚æ“”æ“”éºµå’Œæ°´é¤ƒä¹Ÿæ˜¯ä¸€çµ•ã€‚",
                features: ["â­ 4.8 æ˜Ÿ", "ğŸœ æ‰‹å·¥éºµé£Ÿ", "ğŸ² å€‹äººç«é‹", "ğŸ“ è¿‘æ ¡åœ’"],
                link: "http://www.tianfudiyhotpot.com/"
            },

            // --- ğŸ•Œ é¤å»³ - ä¸­æ±æ–™ç† (Middle Eastern) ---
            {
                id: 104,
                name: "Khalo Naser Syrian Cuisine",
                type: "restaurant",
                category: "middle-eastern",
                lat: 44.5651,
                lng: -123.2586,
                icon: "mosque",
                desc: "å®¶åº­ç¶“ç‡Ÿçš„æ•˜åˆ©äºé¤å»³ï¼Œæ°›åœå„ªé›…æº«é¦¨ã€‚å¿…é»ï¼šç¾Šå°è…¿ã€é›è‚‰æ²™å¨ç‘ªã€ä»¥åŠå£æ„Ÿæ»‘é †çš„é·¹å˜´è±†æ³¥ã€‚å¾…å®¢å¦‚è¦ªã€‚",
                features: ["â­ 4.8 æ˜Ÿ", "ğŸ¥™ æ²™å¨ç‘ª", "ğŸ– ç‡‰ç¾Šè‚‰", "ğŸ›‹ï¸ æ°£æ°›æ¥µä½³"],
                link: "http://www.khalonaser.com/"
            },

            // --- ğŸ‡°ğŸ‡· é¤å»³ - éŸ“å¼æ–™ç† (Korean) ---
            {
                id: 105,
                name: "K-BBQ EXPRESS",
                type: "restaurant",
                category: "korean",
                lat: 44.5690,
                lng: -123.2784,
                icon: "fire",
                desc: "æ ¡åœ’é™„è¿‘çš„è¶…äººæ°£éŸ“å¼å¿«é¤ã€‚çƒ¤è‚‰æ‹Œé£¯ (Bibimbap) å’ŒéŸ“å¼é£¯æ² (Kimbap) æ˜¯è¶•èª²å­¸ç”Ÿçš„æœ€æ„›ã€‚è€é—†éå¸¸è¦ªåˆ‡ã€‚",
                features: ["â­ 4.6 æ˜Ÿ", "ğŸ± çƒ¤è‚‰æ‹Œé£¯", "ğŸ™ é£¯æ²", "âš¡ å‡ºé¤å¿«"],
                link: "https://www.kbbqexpressor.com/"
            },

            // --- ğŸ‡ªğŸ‡º é¤å»³ - æ­ç¾æ–™ç† (European/American) ---
            {
                id: 106,
                name: "Caves Corvallis",
                type: "restaurant",
                category: "european",
                lat: 44.5622,
                lng: -123.2623,
                icon: "wine-glass",
                desc: "èˆ’é©çš„é…’çª–é¤å»³ï¼Œæä¾›çµåˆæ­ç¾é¢¨å‘³çš„æ™‚ä»¤èœå–®ã€‚æ—©åˆé¤éå¸¸å—æ­¡è¿ï¼Œæ“æœ‰è±å¯Œçš„ç²¾é‡€å•¤é…’å–®å’Œæˆ¶å¤–åº§ä½ã€‚",
                features: ["â­ 4.6 æ˜Ÿ", "ğŸ· ç²¾é‡€å•¤é…’", "ğŸ³ æ—©åˆé¤", "ğŸŒ æˆ¶å¤–åº§ä½"],
                link: "http://cavescorvallis.com/"
            },

            // --- ğŸ• é¤å»³ - æŠ«è–© (Pizza) ---
            {
                id: 107,
                name: "Cirello's Pizza",
                type: "restaurant",
                category: "pizza",
                lat: 44.5892,
                lng: -123.2564,
                icon: "pizza-slice",
                desc: "ä½æ–¼ Circle Blvd çš„ç¶“å…¸ç´ç´„å¼æŠ«è–©ã€‚é¤…çš®é…¥è„†ï¼Œæ¨è–¦è¥¿è¥¿é‡ŒæŠ«è–© (Sicilian)ã€‚è£æ½¢å¾©å¤ï¼Œå¾ˆæœ‰ 80 å¹´ä»£é¢¨æ ¼ã€‚",
                features: ["â­ 4.4 æ˜Ÿ", "ğŸ• ç´ç´„æŠ«è–©", "ğŸ§„ çƒ¤å¤§è’œ", "ğŸ“º å¾©å¤é¢¨"],
                link: "http://cirellospizza.com/"
            },
            {
                id: 108,
                name: "American Dream Pizza (Downtown)",
                type: "restaurant",
                category: "pizza",
                lat: 44.5628,
                lng: -123.2608,
                icon: "pizza-slice",
                desc: "Corvallis çš„åœ°æ¨™ç´šæŠ«è–©åº—ã€‚åšç‰‡æŠ«è–©å¯å–®ç‰‡è³¼è²·ï¼Œç”šè‡³æœ‰å±‹é ‚åº§ä½å€ï¼æä¾›å¤šç¨®åœ¨åœ°å•¤é…’ï¼Œæ°£æ°›è¶…Highã€‚",
                features: ["â­ 4.3 æ˜Ÿ", "ğŸ• å–®ç‰‡è²©å”®", "ğŸ™ï¸ å±‹é ‚åº§ä½", "ğŸº åœ¨åœ°å•¤é…’"],
                link: "http://adpizza.com/"
            },

            // --- ğŸ” é¤å»³ - ä¸‰æ˜æ²»/æ¼¢å ¡ (Sandwich/Burger) ---
            {
                id: 109,
                name: "Swan Dive Sandwiches",
                type: "restaurant",
                category: "sandwich",
                lat: 44.5635,
                lng: -123.2634,
                icon: "bread-slice",
                desc: "åœ¨åœ°è©•åƒ¹æ¥µé«˜çš„ä¸‰æ˜æ²»åº—ã€‚è‡ªå®¶çƒ˜ç„™çš„éºµåŒ…æ˜¯éˆé­‚ï¼Œæ­é…æ–°é®®åœ¨åœ°é£Ÿæã€‚è¢«è­½ç‚º Corvallis æœ€å¥½åƒçš„ä¸‰æ˜æ²»ã€‚",
                features: ["â­ 4.8 æ˜Ÿ", "ğŸ¥– è‡ªå®¶éºµåŒ…", "ğŸ¥— åœ¨åœ°é£Ÿæ", "ğŸ¸ ç‰¹è‰²èª¿é…’"],
                link: "https://swandivecorvallis.com/"
            },
            {
                id: 110,
                name: "Bo & Vine Burger",
                type: "restaurant",
                category: "sandwich",
                lat: 44.5648,
                lng: -123.2609,
                icon: "hamburger",
                desc: "å‰µæ„æ‰‹å·¥æ¼¢å ¡åº—ã€‚æ¨è–¦å˜—è©¦èŠ±ç”Ÿé†¬åŸ¹æ ¹æ¼¢å ¡æˆ–æ«»æ¡ƒå“ˆç“¦é‚£è¾£é†¬ã€‚æ“æœ‰è±å¯Œçš„å®¢è£½åŒ–é†¬æ–™å§å° (Sauce Bar)ã€‚",
                features: ["â­ 4.4 æ˜Ÿ", "ğŸ” æ‰‹å·¥æ¼¢å ¡", "ğŸ¶ é†¬æ–™å§", "ğŸŸ å †ç–Šè–¯æ¢"],
                link: "https://boandvine.com/"
            },

            // --- ğŸº é¤å»³ - é…’å§ (Bar) ---
            {
                id: 111,
                name: "Beer:30",
                type: "restaurant",
                category: "bar",
                lat: 44.5474,
                lng: -123.2651,
                icon: "beer",
                desc: "ä½æ–¼å—é‚Šçš„ç²¾é‡€å•¤é…’å§ã€‚æ“æœ‰è¶…é 30 ç¨®è¼ªæ›¿ç”Ÿå•¤ï¼Œåƒ¹æ ¼è¦ªæ°‘ã€‚é€™è£¡æ°£æ°›æ‚ é–’ï¼Œé©åˆå’Œæœ‹å‹èŠå¤©çœ‹çƒè³½ã€‚",
                features: ["â­ 4.8 æ˜Ÿ", "ğŸº 30+ ç”Ÿå•¤", "ğŸ“º é‹å‹•è½‰æ’­", "ğŸ’° åƒ¹æ ¼è¦ªæ°‘"],
                link: "https://maps.google.com/?q=Beer:30+Corvallis"
            },
            {
                id: 112,
                name: "Squirrels Tavern",
                type: "restaurant",
                category: "bar",
                lat: 44.5640,
                lng: -123.2602,
                icon: "beer",
                desc: "Corvallis æœ€å…·ä»£è¡¨æ€§çš„æ­·å²è€é…’é¤¨ã€‚æœ‰æ’çƒæ¡Œã€é–£æ¨“åº§ä½å’Œç¾å‘³çš„ç‚¸è–¯æ¢ã€‚æ˜¯é«”é©—ç•¶åœ°æ–‡åŒ–çš„æœ€ä½³åœ°é»ã€‚",
                features: ["â­ 4.6 æ˜Ÿ", "ğŸ± æ’çƒæ¡Œ", "ğŸŸ å¿…é»è–¯æ¢", "ğŸ›ï¸ æ­·å²è€åº—"],
                link: "http://www.squirrelstavern.com/"
            },

            // --- ğŸ› é¤å»³ - å°åº¦æ–™ç† (Indian) ---
            {
                id: 113,
                name: "Royal India Cuisine",
                type: "restaurant",
                category: "indian",
                lat: 44.5860,
                lng: -123.2553,
                icon: "om",
                desc: "ä½æ–¼åŒ—é‚Šçš„é“åœ°å°åº¦æ–™ç†ï¼Œä¸‹åˆæœ‰æä¾›è‡ªåŠ©é¤ã€‚ç¾Šè‚‰å’–å“©å’Œè”¬èœåº«çˆ¾ç‘ªéå¸¸å—æ­¡è¿ã€‚çƒ¤é¤… (Naan) éƒ½æ˜¯ç¾çƒ¤çš„ã€‚",
                features: ["â­ 4.6 æ˜Ÿ", "ğŸ› å’–å“©", "ğŸ½ï¸ åˆé–“è‡ªåŠ©é¤", "ğŸŒ± ç´ é£Ÿå‹å–„"],
                link: "https://www.royalindiacorvallis.com/"
            },

            // --- ğŸ‡¹ğŸ‡­ é¤å»³ - æ³°å¼æ–™ç† (Thai) ---
            {
                id: 114,
                name: "Tarn Tip Thai Cuisine",
                type: "restaurant",
                category: "thai",
                lat: 44.5690,
                lng: -123.2798,
                icon: "leaf",
                desc: "Monroe è¡—ä¸Šçš„æº«é¦¨æ³°å¼å°é¤¨ã€‚é¦™è„†ç¾…å‹’é´¨å’Œé…ªæ¢¨å’–å“©æ˜¯å¿…é»æ‹›ç‰Œã€‚æœå‹™è¦ªåˆ‡å¿«é€Ÿï¼Œåƒ¹æ ¼ä¹Ÿå¾ˆå¯¦æƒ ã€‚",
                features: ["â­ 4.6 æ˜Ÿ", "ğŸ¦† ç¾…å‹’é´¨", "ğŸ¥‘ é…ªæ¢¨å’–å“©", "âš¡ æœå‹™å¿«é€Ÿ"],
                link: "http://corvallismenus.com/tarntip_thai_menu.pdf"
            }
        ];

        // --- 1.5. localStorage æ•´åˆï¼šåˆä½µé è¨­è³‡æ–™å’Œä½¿ç”¨è€…è³‡æ–™ ---
        function loadPlacesFromStorage() {
            const userPlaces = localStorage.getItem('userCoffeeShops');
            if (userPlaces) {
                try {
                    return [...defaultPlaces, ...JSON.parse(userPlaces)];
                } catch (e) {
                    console.error('Error loading user data:', e);
                    return defaultPlaces;
                }
            }
            return defaultPlaces;
        }

        function savePlaceToStorage(newPlace) {
            const userPlaces = localStorage.getItem('userCoffeeShops');
            let placesArray = [];

            if (userPlaces) {
                try {
                    placesArray = JSON.parse(userPlaces);
                } catch (e) {
                    placesArray = [];
                }
            }

            placesArray.push(newPlace);
            localStorage.setItem('userCoffeeShops', JSON.stringify(placesArray));
        }

        // åˆå§‹åŒ– places é™£åˆ—ï¼ˆåˆä½µé è¨­è³‡æ–™å’Œä½¿ç”¨è€…è³‡æ–™ï¼‰
        let places = loadPlacesFromStorage();

        // --- 2. åˆå§‹åŒ–åœ°åœ– ---
        const map = L.map('map', { 
            zoomControl: false,
            minZoom: 11,
            maxZoom: 18
        }).setView([44.6000, -123.2600], 12);
        
        // åŠ å…¥ç¸®æ”¾æ§åˆ¶å™¨åˆ°å³ä¸‹è§’
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // ä½¿ç”¨æ›´ç¾è§€çš„åœ°åœ–ç“¦ç‰‡
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 20
        }).addTo(map);

        // é£›å…¥å‹•ç•«
        setTimeout(() => {
            map.flyTo([44.5646, -123.2620], 14, { 
                duration: 2,
                easeLinearity: 0.5
            });
        }, 500);

        // --- 3. è‡ªè¨‚ Marker Icon ---
        function createCustomIcon(category, iconName) {
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="custom-marker marker-${category} marker-animate"><i class="fas fa-${iconName}"></i></div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });
        }

        // --- 4. æ¨™è¨˜ç®¡ç†é‚è¼¯ ---
        let markersLayer = L.layerGroup().addTo(map);
        let currentMarkers = [];

        // Icon å°æ‡‰è¡¨
        const categoryIcons = {
            // å’–å•¡åº—
            'aesthetic': 'leaf',
            'study': 'laptop',
            'nerd': 'glasses',
            'community': 'users',
            // é¤å»³
            'mexican': 'pepper-hot',
            'chinese': 'dragon',
            'middle-eastern': 'mosque',
            'korean': 'fire',
            'european': 'wine-glass',
            'pizza': 'pizza-slice',
            'sandwich': 'hamburger',
            'bar': 'beer',
            'indian': 'om',
            'thai': 'leaf'
        };

        function createPopupContent(place) {
            const tagsHtml = place.features.map(f => `<span class="feature-tag">${f}</span>`).join('');
            const t = i18n[currentLanguage];

            return `
                <div class="popup-header">
                    <i class="fas fa-${place.icon}"></i>
                    <span>${place.name}</span>
                </div>
                <div class="popup-body">
                    <div class="popup-tag-container">${tagsHtml}</div>
                    <div class="popup-desc">${place.desc}</div>
                    <a href="${place.link}" target="_blank" class="popup-btn">
                        <i class="fas fa-location-arrow"></i>
                        <span>${t.popup.openInMaps}</span>
                    </a>
                </div>
            `;
        }

        function filterMarkers(category) {
            // 1. æ›´æ–°æŒ‰éˆ•ç‹€æ…‹å’Œå­é¡åˆ¥é¡¯ç¤º
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // æ‰¾åˆ°å°æ‡‰æŒ‰éˆ•ä¸¦æ·»åŠ  active class
            const activeBtn = document.querySelector(`.filter-btn[data-category="${category}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            // æ§åˆ¶å­é¡åˆ¥é¡¯ç¤º/éš±è—
            const coffeeSubcategories = document.getElementById('coffeeSubcategories');
            const restaurantSubcategories = document.getElementById('restaurantSubcategories');

            if (category === 'coffee') {
                coffeeSubcategories.style.display = 'block';
                restaurantSubcategories.style.display = 'none';
            } else if (category === 'restaurant') {
                coffeeSubcategories.style.display = 'none';
                restaurantSubcategories.style.display = 'block';
            } else if (category === 'all') {
                coffeeSubcategories.style.display = 'none';
                restaurantSubcategories.style.display = 'none';
            }

            // 2. æ¸…é™¤åœ°åœ–ä¸Šçš„æ¨™è¨˜
            markersLayer.clearLayers();
            currentMarkers = [];

            // 3. ç¯©é¸è³‡æ–™
            let filteredPlaces;
            if (category === 'all') {
                filteredPlaces = places;
            } else if (category === 'coffee') {
                filteredPlaces = places.filter(p => p.type === 'coffee');
            } else if (category === 'restaurant') {
                filteredPlaces = places.filter(p => p.type === 'restaurant');
            } else {
                // å­é¡åˆ¥ç¯©é¸
                filteredPlaces = places.filter(p => p.category === category);
            }

            // 4. é‡æ–°åŠ ä¸Šæ¨™è¨˜ (å¸¶æœ‰è½ä¸‹å‹•ç•«æ•ˆæœ)
            filteredPlaces.forEach((place, index) => {
                setTimeout(() => {
                    const markerCategory = place.type === 'restaurant' ? 'restaurant' : place.category;
                    const icon = createCustomIcon(markerCategory, place.icon);
                    const marker = L.marker([place.lat, place.lng], { icon: icon });

                    marker.bindPopup(createPopupContent(place), {
                        maxWidth: 300,
                        className: 'custom-popup'
                    });

                    // æ·»åŠ é»æ“Šäº‹ä»¶
                    marker.on('click', function() {
                        map.setView([place.lat, place.lng], 15, {
                            animate: true,
                            duration: 0.5
                        });
                    });

                    // åŠ å…¥åœ–å±¤
                    marker.addTo(markersLayer);
                    currentMarkers.push(marker);

                    // å¦‚æœåªæœ‰ä¸€å€‹çµæœ,è‡ªå‹•èšç„¦
                    if (filteredPlaces.length === 1) {
                        map.setView([place.lat, place.lng], 16, {
                            animate: true,
                            duration: 1
                        });
                        setTimeout(() => marker.openPopup(), 800);
                    }
                }, index * 100);
            });

            // 5. å¦‚æœæœ‰å¤šå€‹çµæœ,èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
            if (filteredPlaces.length > 1) {
                setTimeout(() => {
                    const bounds = L.latLngBounds(filteredPlaces.map(p => [p.lat, p.lng]));
                    map.fitBounds(bounds, {
                        padding: [60, 60],
                        maxZoom: 14,
                        animate: true,
                        duration: 0.8
                    });
                }, filteredPlaces.length * 100 + 200);
            }
        }

        // åˆå§‹è¼‰å…¥å…¨éƒ¨
        setTimeout(() => {
            filterMarkers('all');
        }, 2500);

        // --- 5. æ›´æ–°è¨ˆæ•¸å™¨ ---
        function updateCounts() {
            const counts = {
                // ä¸»é¡åˆ¥
                all: places.length,
                coffee: places.filter(p => p.type === 'coffee').length,
                restaurant: places.filter(p => p.type === 'restaurant').length,

                // å’–å•¡åº—å­é¡åˆ¥
                aesthetic: places.filter(p => p.category === 'aesthetic').length,
                study: places.filter(p => p.category === 'study').length,
                nerd: places.filter(p => p.category === 'nerd').length,
                community: places.filter(p => p.category === 'community').length,

                // é¤å»³å­é¡åˆ¥
                mexican: places.filter(p => p.category === 'mexican').length,
                chinese: places.filter(p => p.category === 'chinese').length,
                'middle-eastern': places.filter(p => p.category === 'middle-eastern').length,
                korean: places.filter(p => p.category === 'korean').length,
                european: places.filter(p => p.category === 'european').length,
                pizza: places.filter(p => p.category === 'pizza').length,
                sandwich: places.filter(p => p.category === 'sandwich').length,
                bar: places.filter(p => p.category === 'bar').length,
                indian: places.filter(p => p.category === 'indian').length,
                thai: places.filter(p => p.category === 'thai').length
            };

            Object.keys(counts).forEach(category => {
                const badge = document.getElementById(`count-${category}`);
                if (badge) {
                    badge.textContent = counts[category];
                }
            });
        }

        // åˆå§‹åŒ–è¨ˆæ•¸å™¨
        updateCounts();

        // --- 6. è¡¨å–®ç®¡ç†å‡½æ•¸ ---
        function openModal() {
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
        }

        function updateCategoryOptions() {
            const placeTypeSelect = document.getElementById('placeType');
            const categorySelect = document.getElementById('category');
            const placeType = placeTypeSelect.value;
            const t = i18n[currentLanguage].form;

            // æ¸…ç©ºç¾æœ‰é¸é …
            categorySelect.innerHTML = `<option value="">${t.categorySelect}</option>`;

            if (placeType === 'coffee') {
                categorySelect.innerHTML += `
                    <option value="aesthetic">${t.categoryOptions.aesthetic}</option>
                    <option value="study">${t.categoryOptions.study}</option>
                    <option value="nerd">${t.categoryOptions.nerd}</option>
                    <option value="community">${t.categoryOptions.community}</option>
                `;
            } else if (placeType === 'restaurant') {
                categorySelect.innerHTML += `
                    <option value="mexican">${t.categoryOptions.mexican}</option>
                    <option value="chinese">${t.categoryOptions.chinese}</option>
                    <option value="middle-eastern">${t.categoryOptions.middleEastern}</option>
                    <option value="korean">${t.categoryOptions.korean}</option>
                    <option value="european">${t.categoryOptions.european}</option>
                    <option value="pizza">${t.categoryOptions.pizza}</option>
                    <option value="sandwich">${t.categoryOptions.sandwich}</option>
                    <option value="bar">${t.categoryOptions.bar}</option>
                    <option value="indian">${t.categoryOptions.indian}</option>
                    <option value="thai">${t.categoryOptions.thai}</option>
                `;
            }
        }

        function updateIconByCategory() {
            const categorySelect = document.getElementById('category');
            const iconInput = document.getElementById('icon');
            const category = categorySelect.value;

            // æ ¹æ“šé¡åˆ¥è‡ªå‹•å¡«å…¥å°æ‡‰çš„åœ–ç¤º
            if (category && categoryIcons[category]) {
                iconInput.value = categoryIcons[category];
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = ''; // æ¢å¾©æ»¾å‹•
            document.getElementById('coffeeShopForm').reset();

            // é‡ç½®ç‰¹è‰²æ¨™ç±¤ç‚ºä¸€å€‹è¼¸å…¥æ¡†
            const container = document.getElementById('featuresContainer');
            container.innerHTML = `
                <div class="feature-input-row">
                    <input type="text" placeholder="ä¾‹å¦‚ï¼šğŸ“¸ é©åˆæ‹ç…§" class="feature-input">
                    <button type="button" onclick="removeFeature(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        function closeModalOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeModal();
            }
        }

        function addFeatureInput() {
            const container = document.getElementById('featuresContainer');
            const newRow = document.createElement('div');
            const t = i18n[currentLanguage].form;
            newRow.className = 'feature-input-row';
            newRow.innerHTML = `
                <input type="text" placeholder="${t.featurePlaceholder}" class="feature-input">
                <button type="button" onclick="removeFeature(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(newRow);
        }

        function removeFeature(button) {
            const container = document.getElementById('featuresContainer');
            const row = button.parentElement;

            // è‡³å°‘ä¿ç•™ä¸€å€‹è¼¸å…¥æ¡†
            if (container.children.length > 1) {
                row.remove();
            } else {
                // å¦‚æœåªå‰©ä¸€å€‹ï¼Œæ¸…ç©ºå®ƒ
                const input = row.querySelector('input');
                input.value = '';
            }
        }

        function submitForm(event) {
            event.preventDefault();

            // æ”¶é›†è¡¨å–®è³‡æ–™
            const form = event.target;
            const formData = new FormData(form);

            // æ”¶é›†æ‰€æœ‰ç‰¹è‰²æ¨™ç±¤
            const featureInputs = document.querySelectorAll('.feature-input');
            const features = Array.from(featureInputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');

            // ç”Ÿæˆæ–°çš„ IDï¼ˆä½¿ç”¨æ™‚é–“æˆ³ä¾†ç¢ºä¿å”¯ä¸€æ€§ï¼‰
            const newId = Date.now();

            // å»ºç«‹æ–°çš„åœ°é»ç‰©ä»¶
            const newPlace = {
                id: newId,
                name: formData.get('shopName'),
                type: formData.get('placeType'),
                category: formData.get('category'),
                lat: parseFloat(formData.get('latitude')),
                lng: parseFloat(formData.get('longitude')),
                icon: formData.get('icon'),
                desc: formData.get('description'),
                features: features,
                link: formData.get('googleMapsLink') || '#'
            };

            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!newPlace.name || !newPlace.type || !newPlace.category || !newPlace.lat || !newPlace.lng || !newPlace.icon || !newPlace.desc) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
                return;
            }

            // é©—è­‰åº§æ¨™ç¯„åœï¼ˆCorvallis å€åŸŸï¼‰
            if (newPlace.lat < 44.0 || newPlace.lat > 45.0 || newPlace.lng > -122.0 || newPlace.lng < -124.0) {
                if (!confirm('æ‚¨è¼¸å…¥çš„åº§æ¨™ä¼¼ä¹ä¸åœ¨ Corvallis å€åŸŸï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                    return;
                }
            }

            // ä¿å­˜åˆ° localStorage
            savePlaceToStorage(newPlace);

            // æ·»åŠ åˆ° places é™£åˆ—
            places.push(newPlace);

            // æ›´æ–°è¨ˆæ•¸å™¨
            updateCounts();

            // é‡æ–°è¼‰å…¥åœ°åœ–æ¨™è¨˜
            filterMarkers('all');

            // é—œé–‰è¡¨å–®ä¸¦é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            closeModal();
            const placeTypeName = newPlace.type === 'coffee' ? 'å’–å•¡åº—' : 'é¤å»³';
            alert('âœ… ' + placeTypeName + 'å·²æˆåŠŸæ–°å¢ï¼\n\n' + newPlace.name + ' å·²ç¶“åŠ å…¥åœ°åœ–äº†ã€‚');

            // è‡ªå‹•èšç„¦åˆ°æ–°å¢çš„åœ°é»
            setTimeout(() => {
                map.setView([newPlace.lat, newPlace.lng], 16, {
                    animate: true,
                    duration: 1
                });

                // æ‰¾åˆ°ä¸¦é–‹å•Ÿæ–°æ¨™è¨˜çš„ popup
                setTimeout(() => {
                    currentMarkers.forEach(marker => {
                        const markerLatLng = marker.getLatLng();
                        if (markerLatLng.lat === newPlace.lat && markerLatLng.lng === newPlace.lng) {
                            marker.openPopup();
                        }
                    });
                }, 500);
            }, 300);
        }

        // éµç›¤å¿«æ·éµï¼šæŒ‰ Esc é—œé–‰æ¨¡æ…‹è¦–çª—
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('modalOverlay');
                if (modal.classList.contains('active')) {
                    closeModal();
                }
            }
        });

    </script>
</body>
</html>
